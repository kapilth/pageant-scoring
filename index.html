<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pageant Scoring App</title>
  <style>
    :root{--bg:#0a0e1a;--card:#f8fafc;--card-dark:#1e293b;--muted:#475569;--text:#1e293b;--text-light:#f8fafc;--accent:#22d3ee;--accent-hover:#06b6d4;--good:#10b981;--warn:#f59e0b;--bad:#ef4444;--border:#e2e8f0;--shadow:rgba(0,0,0,0.1)}
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,'Helvetica Neue',sans-serif;
      color:var(--text);
      background:var(--bg);
      position:relative;
      min-height:100vh;
    }
    body::before{
      content:'';
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background-image:url('./women-festival-2025-new.jpg');
      background-size:cover;
      background-position:center top;
      background-attachment:fixed;
      opacity:0.75;
      z-index:-1;
    }
    header{position:sticky;top:0;z-index:5;background:rgba(255,255,255,0.98);backdrop-filter:blur(16px);border-bottom:1px solid var(--border);box-shadow:0 1px 3px var(--shadow)}
    .wrap{max-width:1200px;margin:0 auto;padding:20px}
    h1{margin:0;font-size:24px;font-weight:700;letter-spacing:-0.5px;color:var(--text)}
    .subtitle{opacity:.7;font-size:13px;margin-top:4px;font-weight:500}
    nav{display:flex;gap:6px;flex-wrap:wrap;margin-top:16px}
    .tab{padding:12px 20px;border:none;border-radius:12px;background:transparent;color:var(--muted);cursor:pointer;font-weight:600;font-size:14px;transition:all 0.2s;position:relative}
    .tab:hover{background:rgba(34,211,238,0.08);color:var(--text)}
    .tab.active{color:var(--accent);background:rgba(34,211,238,0.12)}
    .tab.active::after{content:'';position:absolute;bottom:0;left:20px;right:20px;height:3px;background:var(--accent);border-radius:3px 3px 0 0}
    .grid{display:grid;gap:16px}
    .col-1{grid-template-columns:1fr}
    .col-2{grid-template-columns:repeat(2,1fr)}
    .col-3{grid-template-columns:repeat(3,1fr)}
    @media (max-width:900px){.col-2,.col-3{grid-template-columns:1fr}}
    .card{background:rgba(255,255,255,0.95);border:1px solid var(--border);border-radius:16px;padding:24px;backdrop-filter:blur(12px);box-shadow:0 4px 6px -1px var(--shadow),0 2px 4px -2px var(--shadow);transition:all 0.2s}
    .card:hover{box-shadow:0 10px 15px -3px var(--shadow),0 4px 6px -4px var(--shadow)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .row-between{display:flex;gap:12px;align-items:center;justify-content:space-between}
    label{font-size:13px;font-weight:600;color:var(--text);display:block;margin-bottom:8px}
    input, select, textarea, button{font-size:15px;font-family:inherit}
    input, select, textarea{width:100%;padding:12px 16px;border-radius:12px;border:2px solid var(--border);background:#fff;color:var(--text);transition:all 0.2s;font-weight:500}
    input:hover, select:hover, textarea:hover{border-color:#cbd5e1}
    input:focus, select:focus, textarea:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(34,211,238,0.1)}
    input::placeholder{color:var(--muted);font-weight:400}
    textarea{min-height:80px;resize:vertical}
    select{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%23475569' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3E%3C/svg%3E");background-position:right 12px center;background-repeat:no-repeat;background-size:20px;padding-right:40px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    th, td{padding:14px;border-bottom:1px solid var(--border);text-align:left}
    th{font-size:13px;font-weight:700;color:var(--muted);background:rgba(248,250,252,0.8)}
    tr:hover td{background:rgba(34,211,238,0.04)}
    .btn{padding:12px 24px;border-radius:12px;border:2px solid var(--border);background:#fff;color:var(--text);cursor:pointer;font-weight:600;transition:all 0.2s;box-shadow:0 1px 2px var(--shadow)}
    .btn:hover{background:#f8fafc;border-color:#cbd5e1;transform:translateY(-2px);box-shadow:0 4px 6px -1px var(--shadow)}
    .btn:active{transform:translateY(0);box-shadow:0 1px 2px var(--shadow)}
    .btn.primary{border-color:var(--accent);background:var(--accent);color:#fff;box-shadow:0 4px 6px -1px rgba(34,211,238,0.3)}
    .btn.primary:hover{background:var(--accent-hover);border-color:var(--accent-hover);box-shadow:0 10px 15px -3px rgba(34,211,238,0.4)}
    .btn.bad{border-color:var(--bad);color:var(--bad)}
    .btn.bad:hover{background:rgba(239,68,68,0.05)}
    .pill{padding:6px 12px;border-radius:999px;border:2px solid var(--border);font-size:12px;font-weight:600;background:#fff}
    .pill.ok{border-color:var(--good);color:var(--good);background:rgba(16,185,129,0.08)}
    .pill.warn{border-color:var(--warn);color:var(--warn);background:rgba(245,158,11,0.08)}
    .pill.bad{border-color:var(--bad);color:var(--bad);background:rgba(239,68,68,0.08)}
    .muted{opacity:.7}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;font-size:13px;background:rgba(15,23,42,0.05);padding:2px 6px;border-radius:6px}
    .sticky{position:sticky;top:78px;z-index:4}
    .spacer{height:12px}
    .hide{display:none}
    .test-pass{color:#10b981;font-weight:600}
    .test-fail{color:#ef4444;font-weight:600}
    h2,h3,h4{color:var(--text);font-weight:700;margin-top:0}
    h2{font-size:20px;margin-bottom:8px}
    h3{font-size:18px;margin-bottom:6px}
    h4{font-size:16px;margin-bottom:6px}
  </style>
</head>
<body>
  <header>
    <div class="wrap row-between">
      <div>
        <h1>Pageant Scoring</h1>
        <div class="subtitle">Firestore Cloud Sync ‚Ä¢ Judge Login ‚Ä¢ Audit Log ‚Ä¢ Installable (PWA)</div>
      </div>
      <div class="row" id="adminControls">
        <!-- Admin-only controls - hidden for judges -->
      </div>
    </div>
    <div class="wrap">
      <nav id="tabs"></nav>
    </div>
  </header>

  <main class="wrap">
    <section id="view"></section>
    <div class="spacer"></div>
    <details class="card" id="developerTools" style="display:none">
      <summary>Developer Tools: Self Tests & Admin Actions</summary>
      <div id="testOutput" class="mono"></div>
      <div class="spacer"></div>
      <button class="btn" id="runTestsBtn">Run Self Tests</button>
      <div class="spacer"></div>
      <h4>Unlock Submitted Scores</h4>
      <p class="muted" style="font-size:12px">Select a judge and round to unlock their submitted scores</p>
      <div id="submissionsList" class="muted" style="font-size:12px;margin-bottom:8px"></div>
      <div class="row">
        <select id="unlockJudge" style="width:200px"></select>
        <select id="unlockRound" style="width:200px"></select>
        <button class="btn bad" id="unlockBtn">Unlock Scores</button>
      </div>
    </details>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <script>
    // Pageant Scoring App with Firestore Integration

    // --- Utilities ---
    function uid(){ return Math.random().toString(36).slice(2,9); }
    // Escape for CSV, quote when a cell contains ", or , or \n
    function csvEscape(v){
      const s = String(v);
      const doubled = s.replace(/"/g,'""');
      const needsQuote = /[",\n]/.test(s);
      return needsQuote ? '"'+doubled+'"' : doubled;
    }
    function toCSV(rows){ return rows.map(r=>r.map(v=>csvEscape(v??'')).join(',')).join('\n'); }
    function htmlAttrEscape(v){ return String(v).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // --- State ---
    const LS_KEY = 'pageant_scoring_v2';
    function loadState(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)); }catch{return null;} }
    function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

    const state = loadState() || {
      judges: [],              // {id,name,code}
      contestants: [],         // {id,name,number,category}
      rounds: [],              // {id,name,type,sub,weight,maxPoints}
      scores: {},              // key: `${judgeId}|${contestantId}|${roundId}` -> {score,notes}
      submissions: {},         // key: `${judgeId}|${roundId}` -> timestamp
      settings: { roundAggregation:'average' },
      me: { uid:null, name:'', role:'', judgeId:null },
      ui: { loginMode:null },
      audit: [],
      cloud: { enabled:false, eventCode:'', autoSync:true, firebaseConfig:null }
    };

    // Firebase handles
    let fb = { app:null, db:null, auth:null, unsub:null };

    function logAudit(action, details){
      const entry = {ts:new Date().toISOString(), user:state.me.name||'anon', action, details};
      state.audit.push(entry); 
      saveState();
      if(state.cloud.enabled) pushAudit(entry);
    }
    function scoreKey(j,c,r){ return `${j}|${c}|${r}`; }
    function sumWeights(){ return state.rounds.reduce((s,r)=> s+(+r.weight||0),0); }

    // --- Routing ---
    const routes=[
      {id:'login',label:'Login'},
      {id:'setup',label:'Setup'},
      {id:'scoring',label:'Scoring'},
      {id:'roundResults',label:'Round Results'},
      {id:'finalResults',label:'Final Results'},
      {id:'settings',label:'Settings'}
    ];
    let currentTab='login';
    let setupSubTab='judges'; // Track which setup sub-tab is active

    function visibleTabs(){
      if(state.me.role==='admin') return routes.filter(r=>r.id!=='login');
      if(state.me.role==='judge') return routes.filter(r=>r.id==='scoring');
      return routes.filter(r=>r.id==='login');
    }
    function renderTabs(){
      const el=document.getElementById('tabs'); el.innerHTML='';
      visibleTabs().forEach(r=>{ const b=document.createElement('button'); b.className='tab'+(currentTab===r.id?' active':''); b.textContent=r.label; b.onclick=()=>{currentTab=r.id; render();}; el.appendChild(b); });
    }
    function render(){
      renderTabs();
      updateAdminControls();
      const el=document.getElementById('view');
      if(!state.me.role) currentTab='login';
      if(currentTab==='login') return renderLogin(el);
      if(currentTab==='setup') return renderSetup(el);
      if(currentTab==='scoring') return renderScoring(el);
      if(currentTab==='roundResults') return renderRoundResults(el);
      if(currentTab==='finalResults') return renderFinalResults(el);
      if(currentTab==='settings') return renderSettings(el);
      
      // Populate unlock controls after render (admin only)
      setTimeout(()=>{
        if(state.me && state.me.role === 'admin'){
          populateUnlockSelects();
          setupUnlockButton();
        }
      }, 0);
    }

    // Update admin controls visibility
    function updateAdminControls(){
      const isAdmin = state.me && state.me.role === 'admin';
      const adminControls = document.getElementById('adminControls');
      const developerTools = document.getElementById('developerTools');
      
      // Show or hide admin controls based on role
      if(isAdmin){
        adminControls.innerHTML = `
          <button id="exportJsonBtn">Export JSON</button>
          <button id="exportCsvBtn">Export CSV</button>
          <button onclick="document.getElementById('importJsonInput').click()">Import JSON</button>
          <input type="file" id="importJsonInput" accept=".json" style="display:none">
          <button id="resetBtn" style="background:#e74c3c">Reset All</button>
        `;
        
        // Wire up event handlers to named functions
        document.getElementById('exportJsonBtn').onclick = exportJson;
        document.getElementById('exportCsvBtn').onclick = exportCsv;
        document.getElementById('resetBtn').onclick = resetApp;
        document.getElementById('importJsonInput').onchange = importJson;
        
        developerTools.style.display = 'block';
      } else {
        adminControls.innerHTML = '';
        developerTools.style.display = 'none';
      }
    }

    // --- Auth helpers ---
    function goToLogin(mode=null){ state.ui.loginMode=mode; state.me={uid:null,name:'',role:'',judgeId:null}; saveState(); currentTab='login'; render(); }
    function signInAdmin(name){ state.me.role='admin'; state.me.name=name||'Admin'; saveState(); currentTab='setup'; render(); }
    function signInJudge(name){ state.me.role='judge'; state.me.name=name||'Judge'; saveState(); currentTab='scoring'; render(); }
    function signOut(){ state.me={uid:null,name:'',role:'',judgeId:null}; saveState(); currentTab='login'; render(); }

    // --- Firestore Functions ---
    async function initFirebase(config){
      if(fb.app) return; // Already initialized
      try{
        fb.app = firebase.initializeApp(config);
        fb.db = firebase.firestore();
        fb.auth = firebase.auth();
        state.cloud.firebaseConfig = config;
        console.log('Firebase initialized successfully');
      }catch(err){
        console.error('Firebase init error:', err);
        throw err;
      }
    }

    function eventDoc(){ 
      return fb.db.collection('events').doc(state.cloud.eventCode||'default'); 
    }

    function startFirestoreListener(){
      if(!state.cloud.enabled || !fb.db) return;
      if(fb.unsub) { fb.unsub(); fb.unsub = null; }
      
      fb.unsub = eventDoc().onSnapshot(snap=>{
        const data = snap.data();
        if(!data) return;
        
        // Merge cloud data into local state but keep my user session
        const { me, cloud, ui, ...rest } = data;
        const keep = { me: state.me, cloud: state.cloud, ui: state.ui };
        Object.assign(state, rest, keep);
        saveState();
        render();
      }, err => {
        console.error('Firestore listener error:', err);
      });
    }

    let syncTimer = null;
    async function syncToFirestore(immediate=false){
      if(!state.cloud.enabled || !fb.db) return;
      if(!state.cloud.autoSync && !immediate) return;
      
      clearTimeout(syncTimer);
      syncTimer = setTimeout(async ()=>{
        try{
          const dataToSync = {
            judges: state.judges,
            contestants: state.contestants,
            rounds: state.rounds,
            scores: state.scores,
            submissions: state.submissions,
            settings: state.settings,
            audit: state.audit.slice(-500), // Last 500 entries
            lastSync: new Date().toISOString()
          };
          await eventDoc().set(dataToSync, {merge:true});
          console.log('Synced to Firestore');
        }catch(err){
          console.error('Sync error:', err);
        }
      }, immediate ? 0 : 500);
    }

    async function pushAudit(entry){
      if(!state.cloud.enabled || !fb.db) return;
      try{
        await eventDoc().collection('audit').add(entry);
      }catch(e){
        console.warn('Audit push failed:', e);
      }
    }

    async function loadFromFirestore(){
      if(!state.cloud.enabled || !fb.db) return;
      try{
        const snap = await eventDoc().get();
        if(snap.exists){
          const data = snap.data();
          const { me, cloud, ui, ...rest } = data;
          const keep = { me: state.me, cloud: state.cloud, ui: state.ui };
          Object.assign(state, rest, keep);
          
          // Load audit logs from subcollection
          const auditSnap = await eventDoc().collection('audit').orderBy('ts', 'asc').get();
          const auditFromFirestore = auditSnap.docs.map(doc => doc.data());
          
          // Merge with local audit logs (avoid duplicates by timestamp+action)
          const mergedAudit = [...state.audit];
          auditFromFirestore.forEach(entry => {
            const exists = mergedAudit.some(a => a.ts === entry.ts && a.action === entry.action);
            if(!exists) mergedAudit.push(entry);
          });
          
          // Sort by timestamp
          state.audit = mergedAudit.sort((a,b) => a.ts.localeCompare(b.ts));
          
          saveState();
          render();
          console.log('Loaded from Firestore (including audit logs)');
        }
      }catch(err){
        console.error('Load from Firestore error:', err);
      }
    }

    // --- Views ---
    function renderLogin(root){
      const mode=state.ui.loginMode;
      root.innerHTML=`
        <div class="grid col-1">
          <!-- Event Code Card - Compact -->
          ${state.cloud.enabled ? 
            `<div class="card" style="background:rgba(16,185,129,0.08);border:1px solid var(--good);padding:12px;max-width:400px;margin:0 auto">
              <div class="row" style="gap:8px;justify-content:center">
                <span class="pill ok" style="font-size:13px">‚úì Connected to: ${state.cloud.eventCode}</span>
              </div>
            </div>` :
            `<div class="card" style="background:rgba(34,211,238,0.08);border:2px solid var(--accent);padding:16px;max-width:600px;margin:0 auto">
              <div class="row-between" style="align-items:flex-start">
                <div style="flex:1">
                  <h4 style="color:var(--accent);margin:0 0 8px 0">üì° Event Connection</h4>
                  <p class="muted" style="font-size:12px;margin:0 0 12px 0">Enter event code to connect</p>
                  <div class="row" style="gap:8px">
                    <input id="loginEventCode" value="${state.cloud.eventCode||''}" placeholder="e.g., pageant2025-x8k2m9p5n" style="flex:1;font-size:14px;padding:10px">
                    <button class="btn primary" id="connectEventBtn" style="padding:10px 16px;font-size:14px">Connect</button>
                  </div>
                </div>
              </div>
            </div>`
          }
        </div>
        
        <div class="spacer"></div>
        
        <div class="grid col-2">
          <div class="card" ${mode==='judge'?"style='border:2px solid var(--accent);box-shadow:0 0 0 4px rgba(34,211,238,0.05)'":''}>
            <h3>üë®‚Äç‚öñÔ∏è Judge Login</h3>
            <div class="spacer"></div>
            <label>Judge name</label>
            <input id="jName" placeholder="e.g., Judge Priya">
            <div class="spacer"></div>
            <label>Judge PIN (required)</label>
            <input id="jPin" placeholder="e.g., 7429" type="number">
            <div class="spacer"></div>
            <button class="btn primary" id="jLogin" style="width:100%">Sign In as Judge</button>
          </div>
          <div class="card" ${mode==='admin'?"style='border:2px solid var(--accent);box-shadow:0 0 0 4px rgba(34,211,238,0.05)'":''}>
            <h3>üëë Admin Login</h3>
            <div class="spacer"></div>
            <label>Admin code</label>
            <input id="aCode" type="password" placeholder="Default: ADMIN123">
            <div class="spacer"></div>
            <label>Display name</label>
            <input id="aName" placeholder="e.g., Event Director">
            <div class="spacer"></div>
            <button class="btn primary" id="aLogin" style="width:100%">Sign In as Admin</button>
          </div>
        </div>`;

      // Event connection handler
      const connectBtn = document.getElementById('connectEventBtn');
      if(connectBtn) {
        connectBtn.onclick = async () => {
          const eventCode = document.getElementById('loginEventCode').value.trim();
          if(!eventCode) {
            alert('Please enter an event code');
            return;
          }
          
          connectBtn.textContent = 'Connecting...';
          connectBtn.disabled = true;
          
          try {
            // Use hardcoded Firebase config (secure - same for all users)
            const firebaseConfig = {
              apiKey: "AIzaSyCiglilw9_NLuSZUMGgciEnIPwlZ8vVklI",
              authDomain: "womenfestival2025.firebaseapp.com",
              projectId: "womenfestival2025",
              storageBucket: "womenfestival2025.firebasestorage.app",
              messagingSenderId: "614457754654",
              appId: "1:614457754654:web:4c0ceeb3c29e38bc2bc1ea"
            };
            
            await initFirebase(firebaseConfig);
            
            // Check if event exists
            const eventDoc = await fb.db.collection('events').doc(eventCode).get();
            if(!eventDoc.exists) {
              alert('Event code not found. Please check the code or contact the event organizer.');
              connectBtn.textContent = 'Connect to Event';
              connectBtn.disabled = false;
              return;
            }
            
            state.cloud.enabled = true;
            state.cloud.eventCode = eventCode;
            state.cloud.firebaseConfig = firebaseConfig;
            state.cloud.autoSync = true;
            saveState();
            
            await loadFromFirestore();
            startFirestoreListener();
            
            logAudit('cloud_connected', {eventCode, method: 'login_page'});
            alert('Connected successfully! You can now sign in.');
            render();
            
          } catch(err) {
            alert('Connection failed: ' + err.message);
            connectBtn.textContent = 'Connect to Event';
            connectBtn.disabled = false;
          }
        };
      }

      document.getElementById('aLogin').onclick=()=>{
        const code=(document.getElementById('aCode').value||'').trim();
        const name=(document.getElementById('aName').value||'').trim()||'Admin';
        if(code && code!=='ADMIN123' && code!==localStorage.getItem('pageant_admin_code_v1')){ alert('Invalid admin code'); return; }
        signInAdmin(name);
      };

      function findJudgeByPin(pin){ const p=(pin||'').trim(); return state.judges.find(j=>String(j.code||'').trim()===p)||null; }
      document.getElementById('jLogin').onclick=()=>{
        const name=(document.getElementById('jName').value||'').trim();
        const pin=(document.getElementById('jPin').value||'').trim();
        if(!name){ alert('Enter your name'); return; }
        if(!state.cloud.enabled) {
          alert('Please connect to an event first using the event code above.');
          return;
        }
        const j=findJudgeByPin(pin); if(!j){ alert('Invalid/unknown Judge PIN. Contact the admin.'); return; }
        state.me.judgeId=j.id; saveState(); signInJudge(name);
      };
    }

    function renderSetup(root){
      const isAdmin=state.me.role==='admin';
      const weightTotal=sumWeights();
      root.innerHTML=`
        <div class="card">
          <div class="row-between">
            <div class="row">
              <h3>Event Setup</h3>
              <span class="pill">Role: ${state.me.role||'‚Äî'}</span>
              <div class="pill">User: ${state.me.name||'‚Äî'}</div>
              ${state.cloud.enabled?`<span class="pill ok">‚òÅ Cloud: ${state.cloud.eventCode}</span>`:'<span class="pill warn">‚ö† Local Only</span>'}
            </div>
            <div class="row">
              <button class="btn" id="setupOut">Sign Out</button>
              <button class="btn" id="toJudge">Sign In as Judge</button>
            </div>
          </div>
          <div class="spacer"></div>
          <nav style="display:flex;gap:6px;flex-wrap:wrap">
            <button class="tab ${setupSubTab==='judges'?'active':''}" id="judgesTab">Judges (${state.judges.length})</button>
            <button class="tab ${setupSubTab==='contestants'?'active':''}" id="contestantsTab">Contestants (${state.contestants.length})</button>
            <button class="tab ${setupSubTab==='rounds'?'active':''}" id="roundsTab">Rounds (${state.rounds.length})</button>
          </nav>
        </div>
        
        <div class="spacer"></div>
        
        <div id="setupContent"></div>`;

      document.getElementById('setupOut').onclick=signOut;
      document.getElementById('toJudge').onclick=()=>goToLogin('judge');
      
      // Setup tab switching
      document.getElementById('judgesTab').onclick=()=>{setupSubTab='judges'; renderSetup(root);};
      document.getElementById('contestantsTab').onclick=()=>{setupSubTab='contestants'; renderSetup(root);};
      document.getElementById('roundsTab').onclick=()=>{setupSubTab='rounds'; renderSetup(root);};
      
      const content = document.getElementById('setupContent');
      
      // Render active tab content
      if(setupSubTab === 'judges'){
        content.innerHTML=`
          <div class="card ${isAdmin?'':'muted'}">
            <div class="row-between"><h3>Judges</h3><span class="muted">${state.judges.length} total</span></div>
            <div class="spacer"></div>
            <div class="row"><input id="jAddName" placeholder="Judge name" ${isAdmin?'':'disabled'}><input id="jAddPin" placeholder="PIN" ${isAdmin?'':'disabled'} style="max-width:140px"><button class="btn primary" id="jAdd" ${isAdmin?'':'disabled'}>Add</button></div>
            <div class="spacer"></div>
            <table><thead><tr><th>Name</th><th>PIN</th><th></th></tr></thead><tbody id="jTable"></tbody></table>
          </div>`;
        
        const jt=document.getElementById('jTable');
        jt.innerHTML=state.judges.map(j=>`<tr><td>${j.name}</td><td>${j.code||''}</td><td><button class='btn' data-del='${j.id}'>Remove</button></td></tr>`).join('');
        jt.querySelectorAll('button[data-del]').forEach(b=> b.onclick=()=>{ state.judges=state.judges.filter(x=>x.id!==b.dataset.del); logAudit('remove_judge',b.dataset.del); saveState(); syncToFirestore(); renderSetup(root); });
        
        if(isAdmin){
          document.getElementById('jAdd').onclick=()=>{ const n=document.getElementById('jAddName').value.trim(); const p=(document.getElementById('jAddPin').value||'').trim(); if(!n) return; state.judges.push({id:uid(),name:n,code:p}); logAudit('add_judge',n); saveState(); syncToFirestore(); renderSetup(root); };
        }
      }
      else if(setupSubTab === 'contestants'){
        content.innerHTML=`
          <div class="card ${isAdmin?'':'muted'}">
            <div class="row-between"><h3>Contestants</h3><span class="muted">${state.contestants.length} total</span></div>
            <div class="spacer"></div>
            <div class="grid col-2">
              <input id="cName" placeholder="Contestant name" ${isAdmin?'':'disabled'}>
              <input id="cNum" type="number" placeholder="#" ${isAdmin?'':'disabled'}>
              <input id="cCat" placeholder="Category (e.g., Mrs. India WA)" ${isAdmin?'':'disabled'}>
              <button class="btn primary" id="cAdd" ${isAdmin?'':'disabled'}>Add</button>
            </div>
            <div class="spacer"></div>
            <table><thead><tr><th>#</th><th>Name</th><th>Category</th><th></th></tr></thead><tbody id="cTable"></tbody></table>
          </div>`;
        
        const ct=document.getElementById('cTable');
        ct.innerHTML=state.contestants.map(c=>`<tr><td>${c.number??''}</td><td>${c.name}</td><td>${c.category||''}</td><td><button class='btn' data-dc='${c.id}'>Remove</button></td></tr>`).join('');
        ct.querySelectorAll('button[data-dc]').forEach(b=> b.onclick=()=>{ state.contestants=state.contestants.filter(x=>x.id!==b.dataset.dc); logAudit('remove_contestant',b.dataset.dc); saveState(); syncToFirestore(); renderSetup(root); });
        
        if(isAdmin){
          document.getElementById('cAdd').onclick=()=>{ const n=document.getElementById('cName').value.trim(); const num=parseInt(document.getElementById('cNum').value||''); const cat=document.getElementById('cCat').value.trim(); if(!n) return; state.contestants.push({id:uid(),name:n,number:isNaN(num)?null:num,category:cat}); logAudit('add_contestant',n); saveState(); syncToFirestore(); renderSetup(root); };
        }
      }
      else if(setupSubTab === 'rounds'){
        content.innerHTML=`
          <div class="card ${isAdmin?'':'muted'}">
            <div class="row-between"><h3>Rounds</h3><span class="pill ${Math.abs(weightTotal-100)<=0.5?'ok':'warn'}">Weights: ${weightTotal||0}%</span></div>
            <div class="spacer"></div>
            <div class="grid col-2">
              <input id="rName" placeholder="Round name (e.g., Talent)" ${isAdmin?'':'disabled'}>
              <input id="rType" placeholder="Type (e.g., Stage)" ${isAdmin?'':'disabled'}>
              <input id="rSub" placeholder="Sub-round (optional)" ${isAdmin?'':'disabled'}>
              <input id="rWeight" type="number" placeholder="Weight %" ${isAdmin?'':'disabled'}>
              <input id="rMax" type="number" placeholder="Max points (0‚Äì10)" ${isAdmin?'':'disabled'}>
              <button class="btn primary" id="rAdd" ${isAdmin?'':'disabled'}>Add</button>
            </div>
            <div class="spacer"></div>
            <table><thead><tr><th>Round</th><th>Type</th><th>Sub</th><th>Weight %</th><th>Max</th><th></th></tr></thead><tbody id="rTable"></tbody></table>
          </div>`;
        
        const rt=document.getElementById('rTable');
        rt.innerHTML=state.rounds.map(r=>`<tr><td>${r.name}</td><td>${r.type||''}</td><td>${r.sub||''}</td><td>${r.weight||0}</td><td>${r.maxPoints||10}</td><td><button class='btn' data-dr='${r.id}'>Remove</button></td></tr>`).join('');
        rt.querySelectorAll('button[data-dr]').forEach(b=> b.onclick=()=>{ state.rounds=state.rounds.filter(x=>x.id!==b.dataset.dr); logAudit('remove_round',b.dataset.dr); saveState(); syncToFirestore(); renderSetup(root); });
        
        if(isAdmin){
          document.getElementById('rAdd').onclick=()=>{ const n=document.getElementById('rName').value.trim(); const t=document.getElementById('rType').value.trim(); const s=document.getElementById('rSub').value.trim(); let w=+document.getElementById('rWeight').value||0; let m=+document.getElementById('rMax').value||10; if(!n) return; if(m>10)m=10; if(m<0)m=0; state.rounds.push({id:uid(),name:n,type:t,sub:s,weight:w,maxPoints:m}); logAudit('add_round',n); saveState(); syncToFirestore(); renderSetup(root); };
        }
      }
    }

    function renderScoring(root){
      const judgeOptions=state.judges.map(j=>`<option value='${j.id}'>${j.name}</option>`).join('');
      const lockedId=state.me.judgeId; const lock=state.me.role==='judge'&&lockedId;
      root.innerHTML=`
        <div class="card sticky">
          <div class="row-between"><div class="row"><h3>Judge Scoring</h3><span class="pill">Role: ${state.me.role||'‚Äî'}</span><div class="pill">User: ${state.me.name||'‚Äî'}</div></div><div class="row"><button class="btn" id="sOut">Sign Out</button><button class="btn" id="toAdmin">Sign In as Admin</button></div></div>
        </div>
        <div class="grid col-3">
          <div class="card">
            <h3>Choose Judge & Round</h3>
            <div class="spacer"></div>
            <label>Judge</label>
            <select id="sJudge" ${lock?'disabled':''}>${judgeOptions}</select>
            <div class="spacer"></div>
            <label>Round</label>
            <select id="sRound">${state.rounds.map(r=>`<option value='${r.id}'>${r.name} ${r.sub?('‚Äî '+r.sub):''} (${r.type||'‚Äì'}) ‚Ä¢ Max ${Math.min(r.maxPoints||10,10)}</option>`).join('')}</select>
          </div>
          <div class="card" style="grid-column:span 2;">
            <div class="row-between"><h3>Enter Scores</h3><div class="muted">Contestants: ${state.contestants.length}</div></div>
            <div class="spacer"></div>
            <table>
              <thead><tr><th>#</th><th>Name</th><th>Category</th><th style="width:110px">Score (0‚Äì10)</th><th>Notes</th></tr></thead>
              <tbody id="sBody"></tbody>
            </table>
            <div class="spacer"></div>
            <div class="row-between"><div class="muted" id="sMessage">Scores auto-save. Submit to confirm.</div><button class="btn primary" id="sSubmit">Submit Scores</button></div>
          </div>
        </div>`;

      document.getElementById('sOut').onclick=signOut;
      document.getElementById('toAdmin').onclick=()=>goToLogin('admin');

      const jSel=document.getElementById('sJudge'); const rSel=document.getElementById('sRound'); if(lock) jSel.value=lockedId;
      jSel.onchange=()=>{ if(lock) jSel.value=lockedId; fill(); }; rSel.onchange=fill; fill();

      function fill(){
        const j=jSel.value, r=rSel.value; const round=state.rounds.find(x=>x.id===r); const body=document.getElementById('sBody');
        const submissionKey=`${j}|${r}`;
        const isSubmitted=!!state.submissions[submissionKey];
        const disabledAttr=isSubmitted?' disabled':'';
        const rows=[...state.contestants].sort((a,b)=>(a.number??9999)-(b.number??9999)).map(c=>{ const key=scoreKey(j,c.id,r); const cur=state.scores[key]||{score:'',notes:''}; return `<tr><td>${c.number??''}</td><td>${c.name}</td><td>${c.category||''}</td><td><input data-score='${key}' type='number' step='0.1' min='0' max='10' value='${cur.score}'${disabledAttr}/></td><td><input data-notes='${key}' placeholder='Optional notes' value="${htmlAttrEscape(cur.notes||'')}"${disabledAttr}/></td></tr>`; }).join('');
        body.innerHTML=rows||`<tr><td colspan="5" class="muted">Add contestants in Setup</td></tr>`;
        
        if(!isSubmitted){
          body.querySelectorAll('input[data-score]').forEach(inp=>{ inp.onchange=()=>{ const key=inp.dataset.score; const v=parseFloat(inp.value||''); const clamped=Math.max(0,Math.min(isNaN(v)?0:v,10)); state.scores[key]=state.scores[key]||{}; state.scores[key].score=clamped; const [jId,cId,rId]=key.split('|'); const judge=state.judges.find(j=>j.id===jId); const contestant=state.contestants.find(c=>c.id===cId); const round=state.rounds.find(r=>r.id===rId); logAudit('set_score',`${judge?.name} ‚Üí ${contestant?.name} (${round?.name}): ${clamped}`); saveState(); syncToFirestore(); inp.value=clamped; }; });
          body.querySelectorAll('input[data-notes]').forEach(inp=>{ inp.onchange=()=>{ const key=inp.dataset.notes; state.scores[key]=state.scores[key]||{}; state.scores[key].notes=inp.value; saveState(); syncToFirestore(); }; });
        }
        
        // Update submit button
        const submitBtn=document.getElementById('sSubmit');
        const messageEl=document.getElementById('sMessage');
        if(isSubmitted){
          submitBtn.textContent='‚úì Submitted';
          submitBtn.disabled=true;
          submitBtn.style.opacity='0.6';
          submitBtn.style.cursor='not-allowed';
          messageEl.innerHTML='<span style="color:var(--good)">‚úì Scores submitted and locked. Contact admin to unlock.</span>';
        } else {
          submitBtn.textContent='Submit Scores';
          submitBtn.disabled=false;
          submitBtn.style.opacity='1';
          submitBtn.style.cursor='pointer';
          messageEl.textContent='Scores auto-save. Submit to confirm.';
        }
      }

      document.getElementById('sSubmit').onclick=()=>{ 
        const judgeId = jSel.value;
        const roundId = rSel.value;
        const key = `${judgeId}|${roundId}`;
        
        // Check if any scores have been entered for this judge and round
        let filledScores = 0;
        let emptyScores = 0;
        
        state.contestants.forEach(contestant => {
          const scoreKey = `${judgeId}|${contestant.id}|${roundId}`;
          const scoreData = state.scores[scoreKey];
          
          if(scoreData && scoreData.score !== '' && scoreData.score !== null && scoreData.score !== undefined) {
            filledScores++;
          } else {
            emptyScores++;
          }
        });
        
        // Validate that at least some scores are filled
        if(filledScores === 0) {
          alert('Please enter at least one score before submitting.');
          return;
        }
        
        // Warn if not all scores are filled
        if(emptyScores > 0) {
          const totalContestants = state.contestants.length;
          if(!confirm(`You have only scored ${filledScores} out of ${totalContestants} contestants.\n\nEmpty scores will be counted as 0.\n\nDo you want to submit anyway?`)) {
            return;
          }
        }
        
        // Submit
        state.submissions[key] = new Date().toISOString(); 
        logAudit('submit_scores', key); 
        saveState(); 
        syncToFirestore(true); 
        alert('Scores submitted and locked.'); 
        fill(); // Refresh to show locked state
      };
    }

    function getRoundScore(contestantId, round){
      const vals=state.judges.map(j=> state.scores[scoreKey(j.id,contestantId,round.id)]).filter(Boolean).map(s=>+s.score||0);
      if(!vals.length) return null; const total=vals.reduce((a,b)=>a+b,0);
      const agg=state.settings.roundAggregation==='sum'?total: total/vals.length; return {value:agg, judgesCount:vals.length};
    }

    function renderRoundResults(root){
      root.innerHTML=`
        <div class="card sticky"><div class="row-between"><div class="row" style="gap:16px"><div><label>Round</label><select id="rrRound">${state.rounds.map(r=>`<option value='${r.id}'>${r.name}</option>`).join('')}</select></div><div><label>Sort by</label><select id="rrSort"><option value='desc'>Highest first</option><option value='asc'>Lowest first</option><option value='num'>Contestant #</option><option value='name'>Name</option></select></div></div><div class="row"><button class="btn" id="rrCsv">Download CSV</button><button class="btn" id="rrOut">Sign Out</button><button class="btn" id="rrAdmin">Sign In as Admin</button><button class="btn" id="rrJudge">Sign In as Judge</button></div></div></div>
        <div class="spacer"></div>
        <div class="card"><table><thead><tr><th>#</th><th>Name</th><th>Category</th><th>Score (${state.settings.roundAggregation})</th><th>Judges</th></tr></thead><tbody id="rrBody"></tbody></table></div>`;
      document.getElementById('rrOut').onclick=signOut; document.getElementById('rrAdmin').onclick=()=>goToLogin('admin'); document.getElementById('rrJudge').onclick=()=>goToLogin('judge');
      const rSel=document.getElementById('rrRound'); const sSel=document.getElementById('rrSort'); const body=document.getElementById('rrBody');
      function draw(){ const r=state.rounds.find(x=>x.id===rSel.value); let rows=state.contestants.map(ct=>({ct,rs:getRoundScore(ct.id,r)})); const m=sSel.value; if(m==='desc') rows.sort((a,b)=>(b.rs?.value||-1)-(a.rs?.value||-1)); if(m==='asc') rows.sort((a,b)=>(a.rs?.value?? 1e9)-(b.rs?.value??1e9)); if(m==='num') rows.sort((a,b)=>(a.ct.number??9999)-(b.ct.number??9999)); if(m==='name') rows.sort((a,b)=>a.ct.name.localeCompare(b.ct.name)); body.innerHTML=rows.map(({ct,rs})=>`<tr><td>${ct.number??''}</td><td>${ct.name}</td><td>${ct.category||''}</td><td>${rs?rs.value.toFixed(2):'<span class=\"muted\">‚Äî</span>'}</td><td>${rs?rs.judgesCount:0}/${state.judges.length}</td></tr>`).join(''); }
      rSel.onchange=draw; sSel.onchange=draw; draw();
      document.getElementById('rrCsv').onclick=()=>{ const r=state.rounds.find(x=>x.id===rSel.value); const rows=[["Contestant #","Name","Category",`Score (${state.settings.roundAggregation})`,`Judges`]]; state.contestants.forEach(ct=>{ const rs=getRoundScore(ct.id,r); rows.push([ct.number??'',ct.name,ct.category||'',rs?rs.value.toFixed(2):'',rs?rs.judgesCount:0]); }); download(`${r.name}_round_results.csv`, toCSV(rows)); };
    }

    function renderFinalResults(root){
      const totalW=sumWeights();
      
      // State for sorting and filtering
      if(!state.ui.finalResults) state.ui.finalResults = {sortColumn: 'total', sortDir: 'desc', filter: ''};
      const sortState = state.ui.finalResults;
      
      root.innerHTML=`
        <div class="card sticky">
          <div class="row-between">
            <div class="row" style="gap:16px">
              <div class="pill ${Math.abs(totalW-100)<=0.5?'ok':'warn'}">Total weight: ${totalW||0}%</div>
              <div class="muted">Weights are normalized if not exactly 100%</div>
            </div>
            <div class="row">
              <button class="btn" id="frCsv">Download CSV</button>
              <button class="btn" id="frOut">Sign Out</button>
              <button class="btn" id="frAdmin">Sign In as Admin</button>
              <button class="btn" id="frJudge">Sign In as Judge</button>
            </div>
          </div>
          <div class="spacer"></div>
          <div class="row" style="gap:12px">
            <input id="frFilter" placeholder="üîç Filter by name, number, or category..." value="${sortState.filter}" style="flex:1;font-size:14px">
            <button class="btn" id="frClearFilter">Clear</button>
          </div>
        </div>
        <div class="spacer"></div>
        <div class="card">
          <div style="overflow-x:auto">
            <table style="width:100%;min-width:max-content">
              <thead>
                <tr>
                  <th style="cursor:pointer" data-sort="number"># ${sortState.sortColumn==='number'?(sortState.sortDir==='asc'?'‚Üë':'‚Üì'):''}</th>
                  <th style="cursor:pointer" data-sort="name">Name ${sortState.sortColumn==='name'?(sortState.sortDir==='asc'?'‚Üë':'‚Üì'):''}</th>
                  <th style="cursor:pointer" data-sort="category">Category ${sortState.sortColumn==='category'?(sortState.sortDir==='asc'?'‚Üë':'‚Üì'):''}</th>
                  ${state.rounds.map((r,i)=>`<th style="cursor:pointer" data-sort="round${i}">${r.name} ${sortState.sortColumn===`round${i}`?(sortState.sortDir==='asc'?'‚Üë':'‚Üì'):''}</th>`).join('')}
                  <th style="cursor:pointer" data-sort="total">Total ${sortState.sortColumn==='total'?(sortState.sortDir==='asc'?'‚Üë':'‚Üì'):''}</th>
                </tr>
              </thead>
              <tbody id="frBody"></tbody>
            </table>
          </div>
        </div>`;
      
      document.getElementById('frOut').onclick=signOut; 
      document.getElementById('frAdmin').onclick=()=>goToLogin('admin'); 
      document.getElementById('frJudge').onclick=()=>goToLogin('judge');
      
      // Filter functionality
      const filterInput = document.getElementById('frFilter');
      filterInput.oninput = (e) => {
        sortState.filter = e.target.value;
        saveState();
        renderFinalResultsTable();
      };
      
      document.getElementById('frClearFilter').onclick = () => {
        sortState.filter = '';
        filterInput.value = '';
        saveState();
        renderFinalResultsTable();
      };
      
      // Sorting functionality
      document.querySelectorAll('th[data-sort]').forEach(th => {
        th.onclick = () => {
          const col = th.dataset.sort;
          if(sortState.sortColumn === col) {
            sortState.sortDir = sortState.sortDir === 'asc' ? 'desc' : 'asc';
          } else {
            sortState.sortColumn = col;
            sortState.sortDir = 'desc';
          }
          saveState();
          renderFinalResults(root);
        };
      });
      
      function compute(ct){ 
        const tot=sumWeights()||1; 
        let total=0; 
        const parts=[]; 
        state.rounds.forEach(r=>{ 
          const rs=getRoundScore(ct.id,r); 
          const max=r.maxPoints||10; 
          const pct=rs?(rs.value/max)*100:0; 
          const w=(r.weight||0)/tot; 
          const contrib=pct*w; 
          parts.push(contrib); 
          total+=contrib; 
        }); 
        return {total,parts}; 
      }
      
      function renderFinalResultsTable() {
        let rows = state.contestants.map(ct=>({ct,fr:compute(ct)}));
        
        // Apply filter
        if(sortState.filter) {
          const filterLower = sortState.filter.toLowerCase();
          rows = rows.filter(({ct}) => {
            return ct.name.toLowerCase().includes(filterLower) ||
                   (ct.category||'').toLowerCase().includes(filterLower) ||
                   String(ct.number||'').includes(filterLower);
          });
        }
        
        // Apply sorting
        rows.sort((a,b) => {
          let valA, valB;
          
          if(sortState.sortColumn === 'number') {
            valA = a.ct.number ?? 9999;
            valB = b.ct.number ?? 9999;
          } else if(sortState.sortColumn === 'name') {
            valA = a.ct.name.toLowerCase();
            valB = b.ct.name.toLowerCase();
          } else if(sortState.sortColumn === 'category') {
            valA = (a.ct.category||'').toLowerCase();
            valB = (b.ct.category||'').toLowerCase();
          } else if(sortState.sortColumn === 'total') {
            valA = a.fr.total;
            valB = b.fr.total;
          } else if(sortState.sortColumn.startsWith('round')) {
            const roundIndex = parseInt(sortState.sortColumn.replace('round',''));
            valA = a.fr.parts[roundIndex] || 0;
            valB = b.fr.parts[roundIndex] || 0;
          } else {
            valA = a.fr.total;
            valB = b.fr.total;
          }
          
          if(typeof valA === 'string') {
            return sortState.sortDir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          } else {
            return sortState.sortDir === 'asc' ? valA - valB : valB - valA;
          }
        });
        
        const body = document.getElementById('frBody');
        body.innerHTML = rows.map(({ct,fr})=>`<tr><td>${ct.number??''}</td><td>${ct.name}</td><td>${ct.category||''}</td>${fr.parts.map(v=>`<td>${v.toFixed(2)}</td>`).join('')}<td><strong>${fr.total.toFixed(2)}</strong></td></tr>`).join('') || '<tr><td colspan="100" style="text-align:center" class="muted">No results match filter</td></tr>';
      }
      
      renderFinalResultsTable();
      
      document.getElementById('frCsv').onclick=()=>{ 
        const head=["Contestant #","Name","Category",...state.rounds.map(r=>r.name),"Total (weighted)"]; 
        const out=[head]; 
        let rows = state.contestants.map(ct=>({ct,fr:compute(ct)}));
        rows.forEach(({ct,fr})=> out.push([ct.number??'',ct.name,ct.category||'',...fr.parts.map(v=>v.toFixed(2)),fr.total.toFixed(2)])); 
        download('final_results_weighted.csv', toCSV(out)); 
      };
    }

    function renderSettings(root){
      root.innerHTML=`
        <div class="grid col-2">
          <div class="card">
            <h3>Login</h3>
            <div class="spacer"></div>
            <label>Your name</label>
            <input id="meName" value="${state.me.name||''}" placeholder="e.g., Judge Priya">
            <div class="spacer"></div>
            <label>Role</label>
            <select id="meRole">
              <option value="admin" ${state.me.role==='admin'?'selected':''}>Admin</option>
              <option value="judge" ${state.me.role==='judge'?'selected':''}>Judge</option>
            </select>
            <div class="spacer"></div>
            <div class="row">
              <button class="btn" id="goAdmin">Go Admin</button>
              <button class="btn" id="goJudge">Go Judge</button>
              <button class="btn" id="goLogout">Sign Out</button>
            </div>
          </div>

          <div class="card">
            <h3>Cloud Sync (Firestore)</h3>
            <div class="spacer"></div>
            <div class="pill ${state.cloud.enabled?'ok':'warn'}">${state.cloud.enabled?'‚úì Enabled':'‚óã Disabled'}</div>
            <div class="spacer"></div>
            
            <!-- Quick Connect Option -->
            <div style="background:rgba(34,211,238,0.1);padding:12px;border-radius:8px;border:1px solid rgba(34,211,238,0.3);margin-bottom:12px">
              <h4 style="margin:0 0 8px 0;font-size:14px">‚ö° Quick Connect (Recommended)</h4>
              <p class="muted" style="font-size:12px;margin:0 0 8px 0">Just enter the event code shared by the admin</p>
              <div class="row">
                <input id="quickEventCode" placeholder="e.g., pageant2025" style="flex:1">
                <button class="btn primary" id="quickConnectBtn">Connect</button>
              </div>
            </div>
            
            <!-- Manual Setup Option -->
            <details>
              <summary style="cursor:pointer;font-weight:500;margin-bottom:8px">üîß Manual Setup (Admin Only - First Time)</summary>
              <div class="spacer"></div>
              <label>Firebase Config JSON</label>
              <textarea id="fbConfig" placeholder='{"apiKey":"...","authDomain":"...","projectId":"...","storageBucket":"...","messagingSenderId":"...","appId":"..."}'>${state.cloud.firebaseConfig?JSON.stringify(state.cloud.firebaseConfig,null,2):''}</textarea>
              <div class="spacer"></div>
              <label>Event Code (create a unique code for this event)</label>
              <div class="row">
                <input id="eventCode" value="${state.cloud.eventCode||''}" placeholder="e.g., pageant2025-gWf7kX2" style="flex:1">
                <button class="btn" id="generateCodeBtn" title="Generate random secure code">üé≤ Generate</button>
              </div>
              <div class="spacer"></div>
              <div class="muted" style="font-size:11px;padding:8px;background:rgba(251,191,36,0.1);border-radius:6px;border:1px solid rgba(251,191,36,0.3)">
                ‚ö†Ô∏è <strong>Security Note:</strong> Use a unique, hard-to-guess code. Share only with trusted participants.
              </div>
              <div class="spacer"></div>
              <div class="row">
                <button class="btn primary" id="enableCloudBtn">${state.cloud.enabled?'Reconnect':'Enable Cloud & Save Config'}</button>
              </div>
            </details>
            
            <div class="spacer"></div>
            <div class="row" style="margin-top:12px">
              <button class="btn" id="syncNowBtn" ${state.cloud.enabled?'':'disabled'}>Sync Now</button>
              <button class="btn bad" id="disableCloudBtn" ${state.cloud.enabled?'':'disabled'}>Disable</button>
            </div>
            <div class="spacer"></div>
            <label class="row"><input type="checkbox" id="autoSyncChk" ${state.cloud.autoSync?'checked':''}/> Auto-sync</label>
            <div class="spacer"></div>
            <div class="muted" style="font-size:12px">Cloud stores data in Firestore under <span class="mono">events/{eventCode}</span>. All devices with same event code share data in real-time.</div>
          </div>

          <div class="card">
            <h3>Admin Code</h3>
            <div class="spacer"></div>
            <label>Set/change the Admin access code (used on the Login page)</label>
            <input id="adminCodeNew" placeholder="e.g., SECRET-2025" type="password"/>
            <div class="spacer"></div>
            <button class="btn" id="saveAdminCode">Save Admin Code</button>
            <div class="spacer"></div>
            <div class="muted">Default is <span class="mono">ADMIN123</span> until you change it.</div>
          </div>

          <div class="card" style="grid-column:span 2">
            <div class="row-between">
              <h3>Audit Log</h3>
              <button class="btn" id="auditCsv">Download CSV</button>
            </div>
            <div class="spacer"></div>
            <div class="muted" style="font-size:12px;margin-bottom:8px">
              üìç <strong>Storage Locations:</strong><br>
              ‚Ä¢ Local: Browser localStorage (key: <span class="mono">pageant_scoring_v2</span>)<br>
              ${state.cloud.enabled ? `‚Ä¢ Cloud: Firestore at <span class="mono">events/${state.cloud.eventCode}/audit</span> (subcollection)` : '‚Ä¢ Cloud: Not enabled'}
            </div>
            <table>
              <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr></thead>
              <tbody id="auditBody"></tbody>
            </table>
          </div>
        </div>`;
      
      // Login controls
      document.getElementById('meName').onchange=e=>{state.me.name=e.target.value; saveState();};
      document.getElementById('meRole').onchange=e=>{state.me.role=e.target.value; saveState(); render();};
      document.getElementById('goAdmin').onclick=()=>signInAdmin(state.me.name||'Admin');
      document.getElementById('goJudge').onclick=()=>signInJudge(state.me.name||'Judge');
      document.getElementById('goLogout').onclick=signOut;
      
      // Cloud controls
      
      // Generate secure event code
      document.getElementById('generateCodeBtn').onclick=()=>{
        const randomPart = Math.random().toString(36).slice(2,9) + Math.random().toString(36).slice(2,9);
        const eventName = 'pageant2025';
        const secureCode = `${eventName}-${randomPart}`;
        document.getElementById('eventCode').value = secureCode;
      };
      
      // Quick Connect - fetch config from Firestore
      document.getElementById('quickConnectBtn').onclick=async ()=>{
        const eventCode = document.getElementById('quickEventCode').value.trim();
        if(!eventCode){ alert('Please enter an event code'); return; }
        
        try{
          // Use a temporary Firebase instance to fetch the config
          const tempConfig = state.cloud.firebaseConfig || {
            apiKey: "AIzaSyCiglilw9_NLuSZUMGgciEnIPwlZ8vVklI",
            authDomain: "womenfestival2025.firebaseapp.com",
            projectId: "womenfestival2025",
            storageBucket: "womenfestival2025.firebasestorage.app",
            messagingSenderId: "614457754654",
            appId: "1:614457754654:web:4c0ceeb3c29e38bc2bc1ea"
          };
          
          await initFirebase(tempConfig);
          
          // Fetch config from Firestore
          const configDoc = await fb.db.collection('event-configs').doc(eventCode).get();
          
          if(!configDoc.exists){
            alert('Event code not found. Ask the admin to set up cloud sync first using Manual Setup.');
            return;
          }
          
          const fetchedConfig = configDoc.data().firebaseConfig;
          
          // Reinitialize with fetched config if different
          if(JSON.stringify(fetchedConfig) !== JSON.stringify(tempConfig)){
            fb.app = null;
            await initFirebase(fetchedConfig);
          }
          
          state.cloud.enabled = true;
          state.cloud.eventCode = eventCode;
          state.cloud.firebaseConfig = fetchedConfig;
          saveState();
          
          await loadFromFirestore();
          startFirestoreListener();
          
          logAudit('cloud_enabled', {eventCode, method: 'quick_connect'});
          alert('Connected successfully! Data loaded from cloud.');
          render();
        }catch(err){
          alert('Failed to connect: ' + err.message);
          console.error(err);
        }
      };
      
      // Manual Setup - save config to Firestore
      document.getElementById('enableCloudBtn').onclick=async ()=>{
        const configText = document.getElementById('fbConfig').value.trim();
        const eventCode = document.getElementById('eventCode').value.trim();
        
        if(!configText){ alert('Please paste Firebase config JSON'); return; }
        if(!eventCode){ alert('Please enter an event code'); return; }
        
        try{
          const config = JSON.parse(configText);
          await initFirebase(config);
          state.cloud.enabled = true;
          state.cloud.eventCode = eventCode;
          state.cloud.firebaseConfig = config;
          saveState();
          
          // Save config to Firestore so others can use Quick Connect
          await fb.db.collection('event-configs').doc(eventCode).set({
            firebaseConfig: config,
            createdAt: new Date().toISOString(),
            createdBy: state.me.name || 'admin'
          });
          
          await loadFromFirestore();
          startFirestoreListener();
          await syncToFirestore(true);
          
          logAudit('cloud_enabled', {eventCode, method: 'manual_setup'});
          alert('Cloud sync enabled! Config saved. Share event code "' + eventCode + '" with others.');
          render();
        }catch(err){
          alert('Failed to enable cloud: ' + err.message);
          console.error(err);
        }
      };
      
      document.getElementById('syncNowBtn').onclick=async ()=>{
        if(!state.cloud.enabled) return;
        try{
          await syncToFirestore(true);
          alert('Synced successfully!');
        }catch(err){
          alert('Sync failed: ' + err.message);
        }
      };
      
      document.getElementById('disableCloudBtn').onclick=()=>{
        if(!confirm('Disable cloud sync? Local data will remain but won\'t sync.')) return;
        if(fb.unsub) { fb.unsub(); fb.unsub = null; }
        state.cloud.enabled = false;
        logAudit('cloud_disabled', null);
        saveState();
        render();
      };
      
      document.getElementById('autoSyncChk').onchange=e=>{
        state.cloud.autoSync = e.target.checked; 
        saveState();
      };
      
      // Admin code
      document.getElementById('saveAdminCode').onclick=()=>{ 
        const v=(document.getElementById('adminCodeNew').value||'').trim(); 
        if(!v){alert('Enter a code'); return;} 
        localStorage.setItem('pageant_admin_code_v1', v); 
        alert('Admin code updated.'); 
      };
      
      // Format audit details to be human-readable
      function formatAuditDetails(action, details){
        if(!details) return '‚Äî';
        if(typeof details === 'string'){
          // Check if it's already formatted (contains arrows or colons from new format)
          if(details.includes('‚Üí') || (action === 'set_score' && details.includes(':'))){
            return details;
          }
          // Check if it's a score key format: judgeId|contestantId|roundId (old format)
          if(action === 'set_score' && details.includes('|')){
            const [jId, cId, rId] = details.split('|');
            const judge = state.judges.find(j=>j.id===jId);
            const contestant = state.contestants.find(c=>c.id===cId);
            const round = state.rounds.find(r=>r.id===rId);
            return `${judge?.name||'?'} ‚Üí ${contestant?.name||'?'} (${round?.name||'?'})`;
          }
          // Check if it's a submission key: judgeId|roundId
          if((action === 'submit_scores' || action === 'unlock_scores') && details.includes('|')){
            const [jId, rId] = details.split('|');
            const judge = state.judges.find(j=>j.id===jId);
            const round = state.rounds.find(r=>r.id===rId);
            return `${judge?.name||'?'} - ${round?.name||'?'}`;
          }
          return details;
        }
        return JSON.stringify(details);
      }
      
      // Audit log
      const body=document.getElementById('auditBody'); 
      body.innerHTML=state.audit.slice(-500).reverse().map(a=>`<tr><td>${a.ts}</td><td>${a.user}</td><td>${a.action}</td><td class='mono'>${formatAuditDetails(a.action, a.details)}</td></tr>`).join('')||`<tr><td colspan='4' class='muted'>No activity yet</td></tr>`;
      document.getElementById('auditCsv').onclick=()=>{ 
        const rows=[["ts","user","action","details"],...state.audit.map(a=>[a.ts,a.user,a.action,formatAuditDetails(a.action, a.details)])]; 
        download('audit.csv', toCSV(rows)); 
      };
    }

    // --- Header buttons functions ---
    function download(filename, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/plain'})); a.download=filename; a.click(); }
    
    function exportJson(){ 
      download('pageant_scoring_data.json', JSON.stringify(state,null,2)); 
    }
    
    function exportCsv(){
      const rows=[["Judge","Contestant #","Contestant","Category","Round","Sub","Score","Notes"]];
      state.judges.forEach(j=>{ state.contestants.forEach(c=>{ state.rounds.forEach(r=>{ const s=state.scores[scoreKey(j.id,c.id,r.id)]; if(s){ rows.push([j.name,c.number??'',c.name,c.category||'',r.name,r.sub||'',s.score,s.notes||'']); } }); }); });
      download('all_scores.csv', toCSV(rows));
    }
    
    function resetApp(){ 
      if(confirm('Clear all local data?')){ 
        localStorage.removeItem(LS_KEY); 
        location.reload(); 
      } 
    }
    
    function importJson(e){ 
      const f=e.target.files[0]; 
      if(!f) return; 
      const fr=new FileReader(); 
      fr.onload=()=>{ 
        try{ 
          const obj=JSON.parse(fr.result); 
          Object.assign(state,obj); 
          logAudit('import_json','Imported data from file'); 
          saveState(); 
          syncToFirestore(true); 
          render(); 
        }catch(err){ 
          alert('Import failed: '+err.message); 
        } 
      }; 
      fr.readAsText(f); 
    }

    // --- Self-tests ---
    function runTests(){ const out=[]; function test(n,fn){ try{fn(); out.push('‚úÖ '+n);}catch(e){out.push('‚ùå '+n+' -> '+e.message);} }
      // CSV escaping
      test('csvEscape quotes',()=>{ const got=toCSV([["a\"b",1]]); const exp='"a""b"'; const cell=got.split('\n')[0].split(',')[0]; if(cell!==exp) throw new Error('expected '+exp+' got '+cell); });
      test('toCSV newline wrap',()=>{ const got=toCSV([["x\ny",2]]); const cell=got.split('\n')[0].split(',')[0]; if(cell[0] !== '"' || cell.at(-1) !== '"') throw new Error('newline not quoted'); });
      test('csvEscape comma',()=>{ const got=toCSV([["a,b"]]); const cell=got.split('\n')[0].split(',')[0]; if(cell!== '"a,b"') throw new Error('comma not quoted'); });
      // key and aggregation logic
      test('scoreKey stable',()=>{ if(scoreKey('a','b','c')!=='a|b|c') throw new Error('bad key'); });
      test('round average',()=>{ const st={judges:[{id:'j1'},{id:'j2'}], contestants:[{id:'c1'}], rounds:[{id:'r1',maxPoints:10}], scores:{}}; st.scores[scoreKey('j1','c1','r1')]={score:8}; st.scores[scoreKey('j2','c1','r1')]={score:6}; const vals=[st.scores[scoreKey('j1','c1','r1')].score, st.scores[scoreKey('j2','c1','r1')].score]; const avg=(vals[0]+vals[1])/2; if(avg!==7) throw new Error('avg incorrect'); });
      document.getElementById('testOutput').innerHTML=out.map(x=>`<div class='${x.startsWith('‚úÖ')?'test-pass':'test-fail'}'>${x}</div>`).join(''); }
    document.getElementById('runTestsBtn').onclick=runTests;

    // --- Admin unlock functionality ---
    function populateUnlockSelects(){
      const judgeSelect=document.getElementById('unlockJudge');
      const roundSelect=document.getElementById('unlockRound');
      const submissionsList=document.getElementById('submissionsList');
      
      // Exit if elements don't exist (Developer Tools not visible)
      if(!judgeSelect || !roundSelect) return;
      
      judgeSelect.innerHTML='<option value="">Select Judge...</option>'+state.judges.map(j=>`<option value="${j.id}">${j.name}</option>`).join('');
      roundSelect.innerHTML='<option value="">Select Round...</option>'+state.rounds.map(r=>`<option value="${r.id}">${r.name}</option>`).join('');
      
      // Show current submissions
      if(submissionsList){
        const submissions=Object.keys(state.submissions).map(key=>{
          const [judgeId, roundId]=key.split('|');
          const judge=state.judges.find(j=>j.id===judgeId);
          const round=state.rounds.find(r=>r.id===roundId);
          return `${judge?.name||'Unknown'} - ${round?.name||'Unknown'}`;
        });
        if(submissions.length>0){
          submissionsList.innerHTML='<strong>Current submissions:</strong> '+submissions.join(', ');
        } else {
          submissionsList.innerHTML='<em>No submissions yet</em>';
        }
      }
    }
    
    function setupUnlockButton(){
      const unlockBtn=document.getElementById('unlockBtn');
      
      // Exit if button doesn't exist (Developer Tools not visible)
      if(!unlockBtn) return;
      
      unlockBtn.onclick=()=>{
        const judgeId=document.getElementById('unlockJudge').value;
        const roundId=document.getElementById('unlockRound').value;
        if(!judgeId || !roundId){
          alert('Please select both judge and round');
          return;
        }
        const key=`${judgeId}|${roundId}`;
        if(!state.submissions[key]){
          alert('This judge has not submitted scores for this round');
          return;
        }
        const judge=state.judges.find(j=>j.id===judgeId);
        const round=state.rounds.find(r=>r.id===roundId);
        if(confirm(`Are you sure you want to unlock scores for ${judge?.name} in ${round?.name}? They will be able to edit and resubmit.`)){
          delete state.submissions[key];
          logAudit('unlock_scores',key);
          saveState();
          syncToFirestore(true);
          alert('Scores unlocked successfully. Judge can now edit and resubmit.');
          populateUnlockSelects();
        }
      };
    }

    // --- Initialize and auto-reconnect to Firestore ---
    async function initApp(){
      render();
      populateUnlockSelects();
      setupUnlockButton();
      
      // If cloud was previously enabled, try to reconnect
      if(state.cloud.enabled && state.cloud.firebaseConfig && state.cloud.eventCode){
        try{
          await initFirebase(state.cloud.firebaseConfig);
          await loadFromFirestore();
          startFirestoreListener();
          console.log('Auto-reconnected to Firestore');
        }catch(err){
          console.warn('Failed to auto-reconnect to Firestore:', err);
          // Don't disable cloud - user can manually reconnect from Settings
        }
      }
    }

    // Kick off
    initApp();
  </script>
</body>
</html>
