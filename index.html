<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Professional pageant scoring system with cloud sync and secure authentication for judges and administrators" />
  <meta name="theme-color" content="#7c3aed" />
  <title>Pageant Scoring</title>
  <style>
    /* Royal Elegance Theme - Gold & Purple */
    @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;800&family=Inter:wght@400;500;600;700&display=swap');
    
    :root{
      --bg:#1a0f2e;
      --card:#ffffff;
      --card-dark:#2d1b4e;
      --muted:#9333ea;
      --text:#1a0f2e;
      --text-light:#ffffff;
      --accent:#d4af37;
      --accent-hover:#b8941f;
      --accent-dark:#8b6914;
      --purple:#7c3aed;
      --purple-dark:#6d28d9;
      --purple-light:#a78bfa;
      --good:#10b981;
      --warn:#f59e0b;
      --bad:#ef4444;
      --border:#e9d5ff;
      --shadow:rgba(212,175,55,0.15);
      --glow:rgba(212,175,55,0.3);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:'Playfair Display','Georgia',serif;
      color:var(--text);
      background:linear-gradient(135deg, #1a0f2e 0%, #2d1b4e 50%, #4c1d95 100%);
      position:relative;
      min-height:100vh;
    }
    body::before{
      content:'';
      position:fixed;
      top:0;
      left:0;
      width:100%;
      height:100%;
      background-image:url('./women-festival-2025-new.jpg');
      background-size:cover;
      background-position:center top;
      background-attachment:fixed;
      opacity:0.45;
      z-index:-1;
    }
    body::after{
      content:'';
      position:fixed;
      top:-50%;
      right:-50%;
      width:100%;
      height:100%;
      background:radial-gradient(circle, rgba(212,175,55,0.1) 0%, transparent 70%);
      z-index:-1;
      animation:sparkle 8s ease-in-out infinite;
    }
    @keyframes sparkle{
      0%, 100%{opacity:0.3;transform:scale(1)}
      50%{opacity:0.6;transform:scale(1.1)}
    }
    header{
      position:sticky;
      top:0;
      z-index:5;
      background:transparent;
      backdrop-filter:blur(20px);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:8px 20px}
    @media (max-width:768px){
      .wrap{padding:6px 12px}
    }
    h1{
      margin:0;
      font-size:18px;
      font-weight:700;
      letter-spacing:1px;
      color:var(--accent);
      text-shadow:0 2px 10px rgba(212,175,55,0.5);
      font-family:'Playfair Display',serif;
    }
    @media (max-width:768px){
      h1{font-size:16px;letter-spacing:0.5px}
    }
    .subtitle{
      opacity:.9;
      font-size:10px;
      margin-top:2px;
      font-weight:400;
      color:rgba(255,255,255,0.85);
      font-family:'Inter',sans-serif;
      letter-spacing:0.5px;
    }
    @media (max-width:768px){
      .subtitle{font-size:8px;letter-spacing:0.3px}
    }
    nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px}
    @media (max-width:768px){
      nav{gap:6px;margin-top:8px}
    }
    .tab{
      padding:6px 16px;
      border:none;
      border-radius:50px;
      background:rgba(255,255,255,0.9);
      color:#1a0f2e;
      cursor:pointer;
      font-weight:600;
      font-size:12px;
      font-family:'Inter',sans-serif;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position:relative;
      border:2px solid rgba(212,175,55,0.3);
    }
    @media (max-width:768px){
      .tab{padding:5px 12px;font-size:10px}
    }
    .tab:hover{
      background:rgba(255,255,255,1);
      color:#1a0f2e;
      border-color:rgba(212,175,55,0.6);
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(212,175,55,0.3);
    }
    .tab.active{
      color:#1a0f2e;
      background:linear-gradient(135deg, #d4af37 0%, #f4d03f 100%);
      border-color:var(--accent);
      box-shadow:0 4px 20px rgba(212,175,55,0.5), 0 0 30px rgba(212,175,55,0.3);
      font-weight:700;
    }
    .tab.active::before{
      content:'‚ú®';
      margin-right:6px;
    }
    .grid{display:grid;gap:20px}
    .col-1{grid-template-columns:1fr}
    .col-2{grid-template-columns:repeat(2,1fr)}
    .col-3{grid-template-columns:repeat(3,1fr)}
    @media (max-width:900px){.col-2,.col-3{grid-template-columns:1fr}}
    @media (max-width:768px){
      .grid{gap:12px}
    }
    .card{
      background:rgba(255,255,255,1);
      border:2px solid rgba(212,175,55,0.4);
      border-radius:20px;
      padding:28px;
      backdrop-filter:blur(20px);
      box-shadow:0 8px 24px rgba(212,175,55,0.2), 0 4px 8px rgba(109,40,217,0.15);
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position:relative;
      color:#1a0f2e;
    }
    @media (max-width:768px){
      .card{padding:16px;border-radius:12px}
    }
    .card::before{
      content:'';
      position:absolute;
      top:0;
      left:0;
      right:0;
      height:4px;
      background:linear-gradient(90deg, var(--purple) 0%, var(--accent) 50%, var(--purple) 100%);
      border-radius:20px 20px 0 0;
    }
    .card:hover{
      transform:translateY(-4px);
      box-shadow:0 12px 32px rgba(212,175,55,0.25), 0 8px 16px rgba(109,40,217,0.15);
      border-color:rgba(212,175,55,0.5);
    }
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .row-between{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    @media (max-width:768px){
      .row{gap:8px}
      .row-between{gap:8px}
    }
    label{
      font-size:13px;
      font-weight:700;
      color:var(--purple-dark);
      display:block;
      margin-bottom:8px;
      font-family:'Inter',sans-serif;
      letter-spacing:0.3px;
      text-transform:uppercase;
    }
    @media (max-width:768px){
      label{font-size:11px;margin-bottom:6px}
    }
    input, select, textarea, button{font-size:15px;font-family:'Inter',sans-serif}
    @media (max-width:768px){
      input, select, textarea, button{font-size:14px}
    }
    input, select, textarea{
      width:100%;
      padding:14px 18px;
      border-radius:12px;
      border:2px solid rgba(212,175,55,0.2);
      background:#ffffff;
      color:#1a0f2e;
      transition:all 0.3s;
      font-weight:500;
    }
    @media (max-width:768px){
      input, select, textarea{padding:10px 14px}
    }
    input:hover, select:hover, textarea:hover{border-color:rgba(212,175,55,0.4)}
    input:focus, select:focus, textarea:focus{
      outline:none;
      border-color:var(--accent);
      box-shadow:0 0 0 4px rgba(212,175,55,0.15), 0 4px 12px rgba(212,175,55,0.2);
      background:#fffef8;
    }
    /* Ensure focus is visible for accessibility */
    button:focus-visible, .tab:focus-visible, .btn:focus-visible{
      outline:3px solid var(--accent);
      outline-offset:2px;
    }
    input:focus-visible, textarea:focus-visible, select:focus-visible{
      outline:3px solid var(--purple);
      outline-offset:2px;
    }
    a:focus-visible{
      outline:3px solid var(--accent);
      outline-offset:2px;
      border-radius:2px;
    }
    input::placeholder{color:#9333ea;font-weight:400;opacity:0.6}
    textarea{min-height:80px;resize:vertical}
    select{
      cursor:pointer;
      appearance:none;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%23d4af37' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m6 8 4 4 4-4'/%3E%3C/svg%3E");
      background-position:right 12px center;
      background-repeat:no-repeat;
      background-size:20px;
      padding-right:40px;
    }
    table{width:100%;border-collapse:separate;border-spacing:0;border-radius:12px;overflow:hidden}
    @media (max-width:768px){
      table{font-size:13px}
    }
    th, td{padding:16px;border-bottom:1px solid rgba(212,175,55,0.15);text-align:left}
    @media (max-width:768px){
      th, td{padding:10px 8px}
    }
    td{
      color:#1a0f2e;
    }
    th{
      font-size:12px;
      font-weight:700;
      color:var(--purple-dark);
      background:linear-gradient(135deg, rgba(212,175,55,0.08) 0%, rgba(124,58,237,0.08) 100%);
      text-transform:uppercase;
      letter-spacing:0.5px;
      font-family:'Inter',sans-serif;
    }
    @media (max-width:768px){
      th{font-size:10px;letter-spacing:0.3px}
    }
    tr:hover td{background:rgba(212,175,55,0.05)}
    tr:last-child td{border-bottom:none}
    .btn{
      padding:12px 28px;
      border-radius:50px;
      border:2px solid rgba(212,175,55,0.3);
      background:#ffffff;
      color:#1a0f2e;
      cursor:pointer;
      font-weight:600;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow:0 2px 8px rgba(212,175,55,0.15);
      font-family:'Inter',sans-serif;
    }
    @media (max-width:768px){
      .btn{padding:10px 20px;font-size:13px}
    }
    .btn:hover{
      background:rgba(212,175,55,0.1);
      border-color:var(--accent);
      transform:translateY(-2px);
      box-shadow:0 6px 16px rgba(212,175,55,0.25);
    }
    .btn:active{transform:translateY(0);box-shadow:0 2px 8px rgba(212,175,55,0.15)}
    .btn.primary{
      border-color:var(--accent);
      background:linear-gradient(135deg, var(--accent) 0%, #f4d03f 100%);
      color:#1a0f2e;
      box-shadow:0 4px 16px rgba(212,175,55,0.4);
      font-weight:700;
    }
    .btn.primary:hover{
      background:linear-gradient(135deg, #f4d03f 0%, var(--accent) 100%);
      border-color:var(--accent-dark);
      box-shadow:0 8px 24px rgba(212,175,55,0.5);
    }
    .btn.bad{border-color:var(--bad);color:var(--bad);background:#ffffff}
    .btn.bad:hover{background:rgba(239,68,68,0.08);border-color:#dc2626}
    .pill{
      padding:6px 14px;
      border-radius:999px;
      border:2px solid rgba(212,175,55,0.3);
      font-size:11px;
      font-weight:700;
      background:rgba(255,255,255,0.9);
      font-family:'Inter',sans-serif;
      letter-spacing:0.3px;
      text-transform:uppercase;
    }
    .pill.ok{border-color:var(--good);color:var(--good);background:rgba(16,185,129,0.1)}
    .pill.warn{border-color:var(--warn);color:var(--warn);background:rgba(245,158,11,0.1)}
    .pill.bad{border-color:var(--bad);color:var(--bad);background:rgba(239,68,68,0.1)}
    .muted{opacity:.75;color:var(--purple-dark)}
    .mono{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:12px;
      background:rgba(212,175,55,0.08);
      padding:4px 8px;
      border-radius:6px;
      border:1px solid rgba(212,175,55,0.2);
      color:var(--purple-dark);
    }
    .sticky{position:sticky;top:78px;z-index:4}
    .spacer{height:16px}
    .hide{display:none}
    .test-pass{color:#10b981;font-weight:700}
    .test-fail{color:#ef4444;font-weight:700}
    h2,h3,h4{
      color:var(--purple-dark);
      font-weight:700;
      margin-top:0;
      font-family:'Playfair Display',serif;
    }
    h2{font-size:22px;margin-bottom:10px;color:var(--accent-dark)}
    h3{font-size:20px;margin-bottom:8px;color:var(--purple)}
    h4{font-size:18px;margin-bottom:8px;color:var(--purple-dark)}
    @media (max-width:768px){
      h2{font-size:18px;margin-bottom:8px}
      h3{font-size:16px;margin-bottom:6px}
      h4{font-size:15px;margin-bottom:6px}
    }
    
    /* Royal decorative elements */
    .card h3::before{
      content:'‚óÜ ';
      color:var(--accent);
      margin-right:6px;
      font-size:0.8em;
    }
    
    /* Skip to main content link for screen readers */
    .skip-link{
      position:absolute;
      top:-40px;
      left:0;
      background:var(--accent);
      color:#1a0f2e;
      padding:8px 16px;
      text-decoration:none;
      font-weight:700;
      z-index:100;
      border-radius:0 0 8px 0;
    }
    .skip-link:focus{
      top:0;
    }
    
    /* Improve contrast for better readability */
    .muted{opacity:.85;color:var(--purple-dark);font-weight:500}
    
    /* Screen reader only text */
    .sr-only{
      position:absolute;
      width:1px;
      height:1px;
      padding:0;
      margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border-width:0;
    }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>
  <header role="banner">
    <div class="wrap" style="display:flex;align-items:center;justify-content:space-between;gap:16px;flex-wrap:wrap">
      <div style="display:flex;align-items:center;gap:16px;flex:1;min-width:200px">
        <div>
          <h1>Pageant Scoring</h1>
          <div class="subtitle">üèÜ Professional Judging System</div>
        </div>
        <nav id="tabs" style="margin-top:0"></nav>
      </div>
      <div class="row" id="adminControls">
        <!-- Admin-only controls - hidden for judges -->
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="view"></section>
    <div class="spacer"></div>
    <details class="card" id="developerTools" style="display:none">
      <summary>Developer Tools: Self Tests & Admin Actions</summary>
      <div id="testOutput" class="mono"></div>
      <div class="spacer"></div>
      <button class="btn" id="runTestsBtn">Run Self Tests</button>
      <div class="spacer"></div>
      <h4>Unlock Submitted Scores</h4>
      <p class="muted" style="font-size:12px">Select a judge and round to unlock their submitted scores</p>
      <div id="submissionsList" class="muted" style="font-size:12px;margin-bottom:8px"></div>
      <div class="row">
        <select id="unlockJudge" style="width:250px"></select>
        <select id="unlockRound" style="width:400px"></select>
        <button class="btn bad" id="unlockBtn">Unlock Scores</button>
      </div>
    </details>
  </main>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <script>
    // Pageant Scoring App with Firestore Integration

    // --- Utilities ---
    function uid(){ return Math.random().toString(36).slice(2,9); }
    // Escape for CSV, quote when a cell contains ", or , or \n
    function csvEscape(v){
      const s = String(v);
      const doubled = s.replace(/"/g,'""');
      const needsQuote = /[",\n]/.test(s);
      return needsQuote ? '"'+doubled+'"' : doubled;
    }
    function toCSV(rows){ return rows.map(r=>r.map(v=>csvEscape(v??'')).join(',')).join('\n'); }
    function htmlAttrEscape(v){ return String(v).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // --- Simple Hash Function (SHA-256 via Web Crypto API) ---
    async function hashPassword(password) {
      const msgBuffer = new TextEncoder().encode(password);
      const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      return hashHex;
    }

    // --- State ---
    const LS_KEY = 'pageant_scoring_v2';
    function loadState(){ try{ return JSON.parse(localStorage.getItem(LS_KEY)); }catch{return null;} }
    function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }

    const state = loadState() || {
      judges: [],              // {id,name,code,passwordHash,assignedCategories,assignedRounds}
      contestants: [],         // {id,name,number,category}
      rounds: [],              // {id,name,type,sub,weight,maxPoints,eligibleCategories}
      scores: {},              // key: `${judgeId}|${contestantId}|${roundId}` -> {score,notes}
      submissions: {},         // key: `${judgeId}|${roundId}` -> timestamp
      settings: { roundAggregation:'average', eventPasswordHash:null }, // eventPasswordHash for second layer
      me: { uid:null, name:'', role:'', judgeId:null },
      ui: { loginMode:null, editingRoundId:null, finalResults:{sortColumn:'total',sortDir:'desc',filter:''}, showEventCode:false, scoringView:{judgeId:'',roundId:'',category:''} },
      audit: [],
      cloud: { enabled:false, eventCode:'', autoSync:true, firebaseConfig:null, passwordVerified:false }
    };

    // Firebase handles
    let fb = { app:null, db:null, auth:null, unsub:null };

    function logAudit(action, details){
      const entry = {ts:new Date().toISOString(), user:state.me.name||'anon', action, details};
      state.audit.push(entry); 
      saveState();
      if(state.cloud.enabled) pushAudit(entry);
    }
    function scoreKey(j,c,r){ return `${j}|${c}|${r}`; }
    function sumWeights(){ return state.rounds.reduce((s,r)=> s+(+r.weight||0),0); }

    // --- Routing ---
    const routes=[
      {id:'login',label:'Login'},
      {id:'setup',label:'Setup'},
      {id:'scoring',label:'Scoring'},
      {id:'roundResults',label:'Round Results'},
      {id:'finalResults',label:'Final Results'},
      {id:'settings',label:'Settings'}
    ];
    let currentTab='login';
    let setupSubTab='judges'; // Track which setup sub-tab is active

    function visibleTabs(){
      if(state.me.role==='admin') return routes.filter(r=>r.id!=='login');
      if(state.me.role==='judge') return routes.filter(r=>r.id==='scoring');
      return routes.filter(r=>r.id==='login');
    }
    function renderTabs(){
      const el=document.getElementById('tabs'); el.innerHTML='';
      visibleTabs().forEach(r=>{ const b=document.createElement('button'); b.className='tab'+(currentTab===r.id?' active':''); b.textContent=r.label; b.onclick=()=>{currentTab=r.id; render();}; el.appendChild(b); });
    }
    function render(){
      renderTabs();
      updateAdminControls();
      const el=document.getElementById('view');
      if(!state.me.role) currentTab='login';
      if(currentTab==='login') return renderLogin(el);
      if(currentTab==='setup') return renderSetup(el);
      if(currentTab==='scoring') return renderScoring(el);
      if(currentTab==='roundResults') return renderRoundResults(el);
      if(currentTab==='finalResults') return renderFinalResults(el);
      if(currentTab==='settings') return renderSettings(el);
      
      // Populate unlock controls after render (admin only)
      setTimeout(()=>{
        if(state.me && state.me.role === 'admin'){
          populateUnlockSelects();
          setupUnlockButton();
        }
      }, 0);
    }

    // Update admin controls visibility
    function updateAdminControls(){
      const isAdmin = state.me && state.me.role === 'admin';
      const adminControls = document.getElementById('adminControls');
      const developerTools = document.getElementById('developerTools');
      
      // Show or hide admin controls based on role
      if(isAdmin){
        adminControls.innerHTML = `
          <button id="exportJsonBtn">Export JSON</button>
          <button id="exportCsvBtn">Export CSV</button>
          <button onclick="document.getElementById('importJsonInput').click()">Import JSON</button>
          <input type="file" id="importJsonInput" accept=".json" style="display:none">
          <button id="clearScoresBtn" style="background:#f59e0b">Clear Scores Only</button>
          <button id="resetBtn" style="background:#e74c3c">Reset All</button>
        `;
        
        // Wire up event handlers to named functions
        document.getElementById('exportJsonBtn').onclick = exportJson;
        document.getElementById('exportCsvBtn').onclick = exportCsv;
        document.getElementById('clearScoresBtn').onclick = clearScoresOnly;
        document.getElementById('resetBtn').onclick = resetApp;
        document.getElementById('importJsonInput').onchange = importJson;
        
        developerTools.style.display = 'block';
      } else {
        adminControls.innerHTML = '';
        developerTools.style.display = 'none';
      }
    }

    // --- Auth helpers ---
    function goToLogin(mode=null){ state.ui.loginMode=mode; state.me={uid:null,name:'',role:'',judgeId:null}; saveState(); currentTab='login'; render(); }
    function signInAdmin(name){ state.me.role='admin'; state.me.name=name||'Admin'; saveState(); currentTab='setup'; render(); }
    function signInJudge(name){ state.me.role='judge'; state.me.name=name||'Judge'; saveState(); currentTab='scoring'; render(); }
    async function signOut(){ 
      // Sign out from Firebase Auth if connected
      if(fb.auth) {
        try {
          await fb.auth.signOut();
          logAudit('signout_firebase', {user: state.me.name});
        } catch(error) {
          console.warn('Firebase signout error:', error);
        }
      }
      
      state.me={uid:null,name:'',role:'',judgeId:null}; 
      saveState(); 
      currentTab='login'; 
      render(); 
    }

    // --- Firestore Functions ---
    async function initFirebase(config){
      if(fb.app) return; // Already initialized
      try{
        fb.app = firebase.initializeApp(config);
        fb.db = firebase.firestore();
        fb.auth = firebase.auth();
        state.cloud.firebaseConfig = config;
        console.log('Firebase initialized successfully');
      }catch(err){
        console.error('Firebase init error:', err);
        throw err;
      }
    }

    function eventDoc(){ 
      return fb.db.collection('events').doc(state.cloud.eventCode||'default'); 
    }

    function startFirestoreListener(){
      if(!state.cloud.enabled || !fb.db) return;
      if(fb.unsub) { fb.unsub(); fb.unsub = null; }
      
      fb.unsub = eventDoc().onSnapshot(snap=>{
        const data = snap.data();
        if(!data) return;
        
        // Preserve current judge view selections before updating
        const currentJudge = document.getElementById('sJudge')?.value;
        const currentRound = document.getElementById('sRound')?.value;
        const currentCategory = document.getElementById('sCategoryFilter')?.value;
        
        // Merge cloud data into local state but keep my user session
        const { me, cloud, ui, ...rest } = data;
        const keep = { me: state.me, cloud: state.cloud, ui: state.ui };
        Object.assign(state, rest, keep);
        saveState();
        render();
        
        // Restore selections after render if we're on the scoring page
        if(currentTab === 'scoring' && currentJudge && currentRound) {
          setTimeout(() => {
            const jSel = document.getElementById('sJudge');
            const rSel = document.getElementById('sRound');
            const catFilter = document.getElementById('sCategoryFilter');
            if(jSel && jSel.value !== currentJudge) jSel.value = currentJudge;
            if(rSel && rSel.value !== currentRound) rSel.value = currentRound;
            if(catFilter && currentCategory) catFilter.value = currentCategory;
            // Trigger fill to update the table with restored selections
            const fillEvent = new Event('change');
            rSel?.dispatchEvent(fillEvent);
          }, 0);
        }
      }, err => {
        console.error('Firestore listener error:', err);
      });
    }

    let syncTimer = null;
    async function syncToFirestore(immediate=false){
      if(!state.cloud.enabled || !fb.db) return;
      if(!state.cloud.autoSync && !immediate) return;
      
      clearTimeout(syncTimer);
      syncTimer = setTimeout(async ()=>{
        try{
          const dataToSync = {
            judges: state.judges,
            contestants: state.contestants,
            rounds: state.rounds,
            scores: state.scores,
            submissions: state.submissions,
            settings: state.settings,
            audit: state.audit.slice(-500), // Last 500 entries
            lastSync: new Date().toISOString()
          };
          await eventDoc().set(dataToSync, {merge:true});
          console.log('Synced to Firestore');
        }catch(err){
          console.error('Sync error:', err);
        }
      }, immediate ? 0 : 500);
    }

    async function pushAudit(entry){
      if(!state.cloud.enabled || !fb.db) return;
      try{
        await eventDoc().collection('audit').add(entry);
      }catch(e){
        console.warn('Audit push failed:', e);
      }
    }

    async function loadFromFirestore(){
      if(!state.cloud.enabled || !fb.db) return;
      try{
        const snap = await eventDoc().get();
        if(snap.exists){
          const data = snap.data();
          const { me, cloud, ui, ...rest } = data;
          const keep = { me: state.me, cloud: state.cloud, ui: state.ui };
          Object.assign(state, rest, keep);
          
          // Load audit logs from subcollection
          const auditSnap = await eventDoc().collection('audit').orderBy('ts', 'asc').get();
          const auditFromFirestore = auditSnap.docs.map(doc => doc.data());
          
          // Merge with local audit logs (avoid duplicates by timestamp+action)
          const mergedAudit = [...state.audit];
          auditFromFirestore.forEach(entry => {
            const exists = mergedAudit.some(a => a.ts === entry.ts && a.action === entry.action);
            if(!exists) mergedAudit.push(entry);
          });
          
          // Sort by timestamp
          state.audit = mergedAudit.sort((a,b) => a.ts.localeCompare(b.ts));
          
          saveState();
          render();
          console.log('Loaded from Firestore (including audit logs)');
        }
      }catch(err){
        console.error('Load from Firestore error:', err);
      }
    }

    // --- Views ---
    function renderLogin(root){
      const mode=state.ui.loginMode;
      
      // Helper to mask event code
      const maskedCode = state.cloud.eventCode ? 
        (state.ui.showEventCode ? state.cloud.eventCode : state.cloud.eventCode.substring(0, 4) + '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢') : 
        '';
      
      root.innerHTML=`
        <div class="grid col-1">
          <!-- Event Code Card - Compact -->
          ${state.cloud.enabled && state.cloud.passwordVerified ? 
            `<div class="card" style="background:rgba(16,185,129,0.08);border:1px solid var(--good);padding:12px;max-width:500px;margin:0 auto">
              <div class="row" style="gap:8px;justify-content:center;align-items:center">
                <span class="pill ok" style="font-size:13px">‚úì Connected: ${maskedCode}</span>
                <button class="btn" onclick="state.ui.showEventCode = !state.ui.showEventCode; render();" style="padding:6px 12px;font-size:11px" aria-label="${state.ui.showEventCode ? 'Hide event code' : 'Show event code'}">
                  ${state.ui.showEventCode ? 'üôà Hide' : 'üëÅÔ∏è Show'}
                </button>
              </div>
            </div>` :
            state.cloud.enabled && !state.cloud.passwordVerified ?
            `<div class="card" style="background:rgba(245,158,11,0.08);border:2px solid var(--warn);padding:16px;max-width:600px;margin:0 auto">
              <div class="row-between" style="align-items:flex-start">
                <div style="flex:1">
                  <h4 style="color:var(--warn);margin:0 0 8px 0">üîê Event Password Required</h4>
                  <p class="muted" style="font-size:12px;margin:0 0 12px 0">Enter the event password to continue</p>
                  <div class="row" style="gap:8px">
                    <input id="eventPasswordInput" type="password" placeholder="Event password" style="flex:1;font-size:14px;padding:10px" aria-required="true" aria-label="Enter event password">
                    <button class="btn primary" id="verifyEventPasswordBtn" style="padding:10px 16px;font-size:14px" aria-label="Verify event password">Verify</button>
                  </div>
                </div>
              </div>
            </div>` :
            `<div class="card" style="background:rgba(34,211,238,0.08);border:2px solid var(--accent);padding:16px;max-width:600px;margin:0 auto">
              <div class="row-between" style="align-items:flex-start">
                <div style="flex:1">
                  <h4 style="color:var(--accent);margin:0 0 8px 0">üì° Event Connection</h4>
                  <p class="muted" style="font-size:12px;margin:0 0 12px 0">Enter event code to connect</p>
                  <div class="row" style="gap:8px">
                    <input id="loginEventCode" value="${state.cloud.eventCode||''}" placeholder="e.g., pageant2025-x8k2m9p5n" style="flex:1;font-size:14px;padding:10px" aria-required="true" aria-label="Enter event code">
                    <button class="btn primary" id="connectEventBtn" style="padding:10px 16px;font-size:14px" aria-label="Connect to event">Connect</button>
                  </div>
                </div>
              </div>
            </div>`
          }
        </div>
        
        <div class="spacer"></div>
        
        <div class="grid col-2">
          <div class="card" ${mode==='judge'?"style='border:2px solid var(--accent);box-shadow:0 0 0 4px rgba(34,211,238,0.05)'":''}>
            <h3>üë®‚Äç‚öñÔ∏è Judge Login</h3>
            <div class="spacer"></div>
            <label for="jName">Judge name</label>
            <input id="jName" placeholder="e.g., Judge Priya" ${!state.cloud.passwordVerified?'disabled':''} aria-required="true" aria-label="Enter your name">
            <div class="spacer"></div>
            <label for="jPin">Judge PIN (required)</label>
            <input id="jPin" placeholder="e.g., 7429" type="password" ${!state.cloud.passwordVerified?'disabled':''} aria-required="true" aria-label="Enter your 4-digit PIN">
            <div class="spacer"></div>
            <button class="btn primary" id="jLogin" style="width:100%" ${!state.cloud.passwordVerified?'disabled':''} aria-label="Sign in as judge">Sign In as Judge</button>
            ${!state.cloud.passwordVerified?'<div class="spacer"></div><div class="muted" style="font-size:11px" role="alert">‚ö†Ô∏è Verify event password first</div>':''}
          </div>
          <div class="card" ${mode==='admin'?"style='border:2px solid var(--accent);box-shadow:0 0 0 4px rgba(34,211,238,0.05)'":''}>
            <h3>üëë Admin Login</h3>
            <div class="spacer"></div>
            <label for="aEmail">Admin Email</label>
            <input id="aEmail" type="email" placeholder="admin@example.com" aria-required="true" aria-label="Enter admin email address">
            <div class="spacer"></div>
            <label for="aPassword">Password</label>
            <input id="aPassword" type="password" placeholder="Enter your password" aria-required="true" aria-label="Enter admin password">
            <div class="spacer"></div>
            <button class="btn primary" id="aLogin" style="width:100%" aria-label="Sign in as administrator">Sign In as Admin</button>
            <div class="spacer"></div>
            <div class="muted" style="font-size:11px" role="status">üîí Secured with Firebase Authentication. Admins can login even without event password to manage settings.</div>
          </div>
        </div>`;

      // Event connection handler
      const connectBtn = document.getElementById('connectEventBtn');
      if(connectBtn) {
        connectBtn.onclick = async () => {
          const eventCode = document.getElementById('loginEventCode').value.trim();
          if(!eventCode) {
            alert('Please enter an event code');
            return;
          }
          
          connectBtn.textContent = 'Connecting...';
          connectBtn.disabled = true;
          
          try {
            // Use hardcoded Firebase config (secure - same for all users)
            const firebaseConfig = {
              apiKey: "AIzaSyCiglilw9_NLuSZUMGgciEnIPwlZ8vVklI",
              authDomain: "womenfestival2025.firebaseapp.com",
              projectId: "womenfestival2025",
              storageBucket: "womenfestival2025.firebasestorage.app",
              messagingSenderId: "614457754654",
              appId: "1:614457754654:web:4c0ceeb3c29e38bc2bc1ea"
            };
            
            await initFirebase(firebaseConfig);
            
            // Check if event exists
            const eventDoc = await fb.db.collection('events').doc(eventCode).get();
            if(!eventDoc.exists) {
              alert('Event code not found. Please check the code or contact the event organizer.');
              connectBtn.textContent = 'Connect to Event';
              connectBtn.disabled = false;
              return;
            }
            
            state.cloud.enabled = true;
            state.cloud.eventCode = eventCode;
            state.cloud.firebaseConfig = firebaseConfig;
            state.cloud.autoSync = true;
            
            await loadFromFirestore();
            startFirestoreListener();
            
            // Check if event has a password
            if(state.settings.eventPasswordHash) {
              state.cloud.passwordVerified = false;
              saveState();
              logAudit('cloud_connected_pending_password', {eventCode, method: 'login_page'});
              render();
            } else {
              // No password required - full access
              state.cloud.passwordVerified = true;
              saveState();
              logAudit('cloud_connected', {eventCode, method: 'login_page'});
              alert('Connected successfully! You can now sign in.');
              render();
            }
            
          } catch(err) {
            alert('Connection failed: ' + err.message);
            connectBtn.textContent = 'Connect to Event';
            connectBtn.disabled = false;
          }
        };
      }
      
      // Event password verification handler
      const verifyBtn = document.getElementById('verifyEventPasswordBtn');
      if(verifyBtn) {
        verifyBtn.onclick = async () => {
          const password = document.getElementById('eventPasswordInput').value.trim();
          if(!password) {
            alert('Please enter the event password');
            return;
          }
          
          verifyBtn.textContent = 'Verifying...';
          verifyBtn.disabled = true;
          
          try {
            const passwordHash = await hashPassword(password);
            
            if(passwordHash === state.settings.eventPasswordHash) {
              state.cloud.passwordVerified = true;
              saveState();
              logAudit('event_password_verified', {eventCode: state.cloud.eventCode});
              alert('Password verified! You can now sign in.');
              render();
            } else {
              alert('Incorrect event password. Please try again or contact the event organizer.');
              verifyBtn.textContent = 'Verify';
              verifyBtn.disabled = false;
              document.getElementById('eventPasswordInput').value = '';
            }
          } catch(err) {
            alert('Verification failed: ' + err.message);
            verifyBtn.textContent = 'Verify';
            verifyBtn.disabled = false;
          }
        };
      }

      document.getElementById('aLogin').onclick=async ()=>{
        const email=(document.getElementById('aEmail').value||'').trim();
        const password=(document.getElementById('aPassword').value||'').trim();
        
        if(!email || !password){ 
          alert('Please enter both email and password'); 
          return; 
        }
        
        // Initialize Firebase if not already done (for admin-first login)
        if(!state.cloud.enabled) {
          const firebaseConfig = {
            apiKey: "AIzaSyCiglilw9_NLuSZUMGgciEnIPwlZ8vVklI",
            authDomain: "womenfestival2025.firebaseapp.com",
            projectId: "womenfestival2025",
            storageBucket: "womenfestival2025.firebasestorage.app",
            messagingSenderId: "614457754654",
            appId: "1:614457754654:web:4c0ceeb3c29e38bc2bc1ea"
          };
          
          try {
            // Check if Firebase app already exists
            let app;
            try {
              app = firebase.app();
            } catch(e) {
              app = firebase.initializeApp(firebaseConfig);
            }
            fb.auth = firebase.auth(app);
            fb.db = firebase.firestore(app);
            state.cloud.firebaseConfig = firebaseConfig;
            state.cloud.enabled = true;
            logAudit('firebase_init', {source: 'admin_login'});
          } catch(err) {
            console.error('Firebase init error:', err);
            alert('Failed to initialize Firebase: ' + err.message);
            return;
          }
        }
        
        if(!fb.auth) {
          console.error('fb.auth is null or undefined');
          alert('Authentication service not available. Please refresh the page and try again.');
          return;
        }
        
        const loginBtn = document.getElementById('aLogin');
        loginBtn.disabled = true;
        loginBtn.textContent = 'Signing in...';
        
        try {
          const userCredential = await fb.auth.signInWithEmailAndPassword(email, password);
          const user = userCredential.user;
          
          state.me.uid = user.uid;
          state.me.name = user.displayName || user.email.split('@')[0];
          state.me.role = 'admin';
          state.me.judgeId = null;
          
          // Admin bypass: automatically verify event password since admin has full access
          state.cloud.passwordVerified = true;
          
          saveState();
          logAudit('admin_login_firebase', {email: user.email, uid: user.uid});
          
          currentTab='setup';
          render();
        } catch(error) {
          console.error('Login error:', error);
          let errorMsg = 'Login failed. ';
          
          if(error.code === 'auth/user-not-found') {
            errorMsg += 'No account found with this email.';
          } else if(error.code === 'auth/wrong-password') {
            errorMsg += 'Incorrect password.';
          } else if(error.code === 'auth/invalid-email') {
            errorMsg += 'Invalid email address.';
          } else if(error.code === 'auth/too-many-requests') {
            errorMsg += 'Too many failed attempts. Try again later.';
          } else {
            errorMsg += error.message;
          }
          
          alert(errorMsg);
          loginBtn.disabled = false;
          loginBtn.textContent = 'Sign In as Admin';
        }
      };

      function findJudgeByPin(pin){ const p=(pin||'').trim(); return state.judges.find(j=>String(j.code||'').trim()===p)||null; }
      async function findJudgeByPinHash(pin){ 
        const pinHash = await hashPassword(pin.trim());
        return state.judges.find(j=>j.passwordHash === pinHash) || null;
      }
      
      document.getElementById('jLogin').onclick=async ()=>{
        const name=(document.getElementById('jName').value||'').trim();
        const pin=(document.getElementById('jPin').value||'').trim();
        if(!name){ alert('Enter your name'); return; }
        if(!pin){ alert('Enter your PIN'); return; }
        if(!state.cloud.enabled) {
          alert('Please connect to an event first using the event code above.');
          return;
        }
        if(!state.cloud.passwordVerified) {
          alert('Please verify the event password first.');
          return;
        }
        
        // Find judge by name (case-insensitive)
        const judge = state.judges.find(j => j.name.toLowerCase() === name.toLowerCase());
        if(!judge) {
          alert('Judge name not found. Please check your name or contact the admin.');
          return;
        }
        
        // Validate PIN against this specific judge
        const pinHash = await hashPassword(pin);
        if(judge.passwordHash && judge.passwordHash === pinHash) {
          // Correct PIN with hashed password
          state.me.judgeId = judge.id;
          state.me.name = judge.name; // Use the exact name from database
          saveState();
          signInJudge(judge.name);
        } else if(judge.code && judge.code === pin) {
          // Legacy plaintext password - migrate to hash
          judge.passwordHash = await hashPassword(pin);
          delete judge.code;
          state.me.judgeId = judge.id;
          state.me.name = judge.name;
          saveState();
          syncToFirestore();
          signInJudge(judge.name);
        } else {
          alert('Incorrect PIN for ' + judge.name + '. Please try again or contact the admin.');
          return;
        }
      };
    }

    function renderSetup(root){
      const isAdmin=state.me.role==='admin';
      const weightTotal=sumWeights();
      root.innerHTML=`
        <div class="card">
          <div class="row-between">
            <div class="row">
              <h3>Event Setup</h3>
              <span class="pill">Role: ${state.me.role||'‚Äî'}</span>
              <div class="pill">User: ${state.me.name||'‚Äî'}</div>
              ${state.cloud.enabled?`<span class="pill ok">‚òÅ Cloud: ${state.cloud.eventCode}</span>`:'<span class="pill warn">‚ö† Local Only</span>'}
            </div>
            <div class="row">
              <button class="btn" id="setupOut">Sign Out</button>
              <button class="btn" id="toJudge">Sign In as Judge</button>
            </div>
          </div>
          <div class="spacer"></div>
          <nav style="display:flex;gap:6px;flex-wrap:wrap">
            <button class="tab ${setupSubTab==='judges'?'active':''}" id="judgesTab">Judges (${state.judges.length})</button>
            <button class="tab ${setupSubTab==='contestants'?'active':''}" id="contestantsTab">Contestants (${state.contestants.length})</button>
            <button class="tab ${setupSubTab==='rounds'?'active':''}" id="roundsTab">Rounds (${state.rounds.length})</button>
          </nav>
        </div>
        
        <div class="spacer"></div>
        
        <div id="setupContent"></div>`;

      document.getElementById('setupOut').onclick=signOut;
      document.getElementById('toJudge').onclick=()=>goToLogin('judge');
      
      // Setup tab switching
      document.getElementById('judgesTab').onclick=()=>{setupSubTab='judges'; renderSetup(root);};
      document.getElementById('contestantsTab').onclick=()=>{setupSubTab='contestants'; renderSetup(root);};
      document.getElementById('roundsTab').onclick=()=>{setupSubTab='rounds'; renderSetup(root);};
      
      const content = document.getElementById('setupContent');
      
      // Render active tab content
      if(setupSubTab === 'judges'){
        content.innerHTML=`
          <div class="card ${isAdmin?'':'muted'}">
            <div class="row-between"><h3>Judges</h3><span class="muted">${state.judges.length} total</span></div>
            <div class="spacer"></div>
            <div class="row"><input id="jAddName" placeholder="Judge name" ${isAdmin?'':'disabled'}><input id="jAddPin" placeholder="PIN (4-6 digits)" type="password" ${isAdmin?'':'disabled'} style="max-width:160px"><button class="btn primary" id="jAdd" ${isAdmin?'':'disabled'}>Add</button></div>
            <div class="spacer"></div>
            <table>
              <thead><tr><th>Name</th><th>PIN Status</th><th>Assignments</th><th>Actions</th></tr></thead>
              <tbody id="jTable"></tbody>
            </table>
          </div>`;
        
        const jt=document.getElementById('jTable');
        jt.innerHTML=state.judges.map(j=>{
          const hasAssignments = (j.assignedCategories && j.assignedCategories.length > 0) || (j.assignedRounds && j.assignedRounds.length > 0);
          const assignmentText = hasAssignments ? 
            `${j.assignedCategories?.length || 0} categories, ${j.assignedRounds?.length || 0} rounds` : 
            'No assignments';
          return `
          <tr>
            <td>${j.name}</td>
            <td><span class="pill ${j.passwordHash?'ok':'warn'}">${j.passwordHash?'‚úì Secured':'‚ö† Plaintext'}</span></td>
            <td><span class="muted" style="font-size:11px">${assignmentText}</span></td>
            <td>
              <button class='btn' data-assign='${j.id}' style="font-size:12px;padding:8px 12px">Assign</button>
              <button class='btn' data-reset='${j.id}' style="font-size:12px;padding:8px 12px">Reset PIN</button>
              <button class='btn bad' data-del='${j.id}' style="font-size:12px;padding:8px 12px">Remove</button>
            </td>
          </tr>
        `}).join('');
        
        jt.querySelectorAll('button[data-assign]').forEach(b=> b.onclick=()=>{ 
          const judge = state.judges.find(j=>j.id===b.dataset.assign);
          if(!judge) return;
          showAssignmentDialog(judge, root);
        });
        
        jt.querySelectorAll('button[data-del]').forEach(b=> b.onclick=()=>{ 
          if(confirm(`Remove judge ${state.judges.find(j=>j.id===b.dataset.del)?.name}?`)) {
            state.judges=state.judges.filter(x=>x.id!==b.dataset.del); 
            logAudit('remove_judge',b.dataset.del); 
            saveState(); 
            syncToFirestore(); 
            renderSetup(root); 
          }
        });
        
        jt.querySelectorAll('button[data-reset]').forEach(b=> b.onclick=async ()=>{ 
          const judge = state.judges.find(j=>j.id===b.dataset.reset);
          if(!judge) return;
          
          const newPin = prompt(`Enter new PIN for ${judge.name}:`);
          if(!newPin || newPin.trim().length < 4) {
            alert('PIN must be at least 4 characters');
            return;
          }
          
          judge.passwordHash = await hashPassword(newPin.trim());
          delete judge.code; // Remove any old plaintext
          logAudit('reset_judge_pin', {judgeId: judge.id, judgeName: judge.name});
          saveState(); 
          syncToFirestore(); 
          alert(`PIN reset successfully for ${judge.name}`);
          renderSetup(root);
        });
        
        if(isAdmin){
          document.getElementById('jAdd').onclick=async ()=>{ 
            const n=document.getElementById('jAddName').value.trim(); 
            const p=(document.getElementById('jAddPin').value||'').trim(); 
            if(!n) { alert('Enter judge name'); return; }
            if(!p || p.length < 4) { alert('PIN must be at least 4 characters'); return; }
            
            const passwordHash = await hashPassword(p);
            state.judges.push({id:uid(), name:n, passwordHash}); 
            logAudit('add_judge',n); 
            saveState(); 
            syncToFirestore(); 
            document.getElementById('jAddName').value = '';
            document.getElementById('jAddPin').value = '';
            renderSetup(root); 
          };
        }
      }
      else if(setupSubTab === 'contestants'){
        content.innerHTML=`
          <div class="card ${isAdmin?'':'muted'}">
            <div class="row-between"><h3>Contestants</h3><span class="muted">${state.contestants.length} total</span></div>
            <div class="spacer"></div>
            <div class="grid col-2">
              <input id="cName" placeholder="Contestant name" ${isAdmin?'':'disabled'}>
              <input id="cNum" type="number" placeholder="#" ${isAdmin?'':'disabled'}>
              <input id="cCat" placeholder="Category (e.g., Mrs. India WA)" ${isAdmin?'':'disabled'}>
              <button class="btn primary" id="cAdd" ${isAdmin?'':'disabled'}>Add</button>
            </div>
            <div class="spacer"></div>
            <table><thead><tr><th>#</th><th>Name</th><th>Category</th><th></th></tr></thead><tbody id="cTable"></tbody></table>
          </div>`;
        
        const ct=document.getElementById('cTable');
        ct.innerHTML=state.contestants.map(c=>`<tr><td>${c.number??''}</td><td>${c.name}</td><td>${c.category||''}</td><td><button class='btn' data-dc='${c.id}'>Remove</button></td></tr>`).join('');
        ct.querySelectorAll('button[data-dc]').forEach(b=> b.onclick=()=>{ state.contestants=state.contestants.filter(x=>x.id!==b.dataset.dc); logAudit('remove_contestant',b.dataset.dc); saveState(); syncToFirestore(); renderSetup(root); });
        
        if(isAdmin){
          document.getElementById('cAdd').onclick=()=>{ const n=document.getElementById('cName').value.trim(); const num=parseInt(document.getElementById('cNum').value||''); const cat=document.getElementById('cCat').value.trim(); if(!n) return; state.contestants.push({id:uid(),name:n,number:isNaN(num)?null:num,category:cat}); logAudit('add_contestant',n); saveState(); syncToFirestore(); renderSetup(root); };
        }
      }
      else if(setupSubTab === 'rounds'){
        // Get unique categories from contestants
        const uniqueCategories = [...new Set(state.contestants.map(c => c.category).filter(Boolean))];
        
        // Check if editing mode
        const editingRoundId = state.ui.editingRoundId || null;
        const editingRound = editingRoundId ? state.rounds.find(r => r.id === editingRoundId) : null;
        
        content.innerHTML=`
          <div class="card ${isAdmin?'':'muted'}">
            <div class="row-between">
              <h3>Rounds</h3>
              <span class="pill ${Math.abs(weightTotal-100)<=0.5?'ok':'warn'}">Weights: ${weightTotal||0}%</span>
            </div>
            <div class="spacer"></div>
            ${editingRound ? `<div style="background:rgba(34,211,238,0.1);padding:12px;border-radius:8px;margin-bottom:12px;border:1px solid var(--accent)"><strong>Editing:</strong> ${editingRound.name}</div>` : ''}
            <div class="grid col-2">
              <input id="rName" placeholder="Round name (e.g., Talent)" value="${editingRound ? htmlAttrEscape(editingRound.name) : ''}" ${isAdmin?'':'disabled'}>
              <input id="rType" placeholder="Type (e.g., Stage)" value="${editingRound ? htmlAttrEscape(editingRound.type || '') : ''}" ${isAdmin?'':'disabled'}>
              <input id="rSub" placeholder="Sub-round (optional)" value="${editingRound ? htmlAttrEscape(editingRound.sub || '') : ''}" ${isAdmin?'':'disabled'}>
              <input id="rWeight" type="number" placeholder="Weight %" value="${editingRound ? editingRound.weight || 0 : ''}" ${isAdmin?'':'disabled'}>
              <input id="rMax" type="number" placeholder="Max points (0‚Äì10)" value="${editingRound ? editingRound.maxPoints || 10 : ''}" ${isAdmin?'':'disabled'}>
              <div style="grid-column: span 2;">
                <label>Eligible Categories (leave empty for all)</label>
                <div id="rCategoriesContainer" style="display:flex;flex-wrap:wrap;gap:8px;padding:12px;border:2px solid var(--border);border-radius:12px;background:#fff;min-height:50px">
                  ${uniqueCategories.length > 0 ? 
                    uniqueCategories.map(cat => {
                      const isChecked = editingRound && editingRound.eligibleCategories && editingRound.eligibleCategories.includes(cat);
                      return `
                        <label style="display:flex;align-items:center;gap:6px;padding:6px 12px;border:1px solid var(--border);border-radius:8px;background:#f8fafc;cursor:pointer;font-size:13px">
                          <input type="checkbox" class="rCatCheck" value="${htmlAttrEscape(cat)}" ${isChecked ? 'checked' : ''} style="width:auto;margin:0">
                          <span>${cat}</span>
                        </label>
                      `;
                    }).join('') :
                    '<span class="muted" style="font-size:12px">No categories defined yet. Add contestants with categories first.</span>'
                  }
                </div>
              </div>
              <div class="row" style="grid-column: span 2;gap:8px">
                <button class="btn primary" id="rSave" ${isAdmin?'':'disabled'}>${editingRound ? 'Update Round' : 'Add Round'}</button>
                ${editingRound ? `<button class="btn" id="rCancelEdit" ${isAdmin?'':'disabled'}>Cancel</button>` : ''}
              </div>
            </div>
            <div class="spacer"></div>
            <table>
              <thead><tr><th>Round</th><th>Type</th><th>Sub</th><th>Eligible Categories</th><th>Weight %</th><th>Max</th><th></th></tr></thead>
              <tbody id="rTable"></tbody>
            </table>
          </div>`;
        
        const rt=document.getElementById('rTable');
        rt.innerHTML=state.rounds.map(r=>{
          const eligibleText = r.eligibleCategories && r.eligibleCategories.length > 0 
            ? r.eligibleCategories.join(', ') 
            : '<span class="muted">All</span>';
          const isEditing = editingRoundId === r.id;
          return `<tr ${isEditing ? 'style="background:rgba(34,211,238,0.08)"' : ''}><td>${r.name}</td><td>${r.type||''}</td><td>${r.sub||''}</td><td style="font-size:12px">${eligibleText}</td><td>${r.weight||0}</td><td>${r.maxPoints||10}</td><td><button class='btn' data-edit='${r.id}' ${isEditing ? 'disabled' : ''}>Edit</button> <button class='btn bad' data-dr='${r.id}'>Remove</button></td></tr>`;
        }).join('');
        
        // Edit button handlers
        rt.querySelectorAll('button[data-edit]').forEach(b=> b.onclick=()=>{ 
          state.ui.editingRoundId = b.dataset.edit;
          saveState();
          renderSetup(root); 
        });
        
        // Remove button handlers
        rt.querySelectorAll('button[data-dr]').forEach(b=> b.onclick=()=>{ 
          if(confirm('Are you sure you want to remove this round? All scores for this round will remain but the round definition will be deleted.')) {
            state.rounds=state.rounds.filter(x=>x.id!==b.dataset.dr); 
            if(state.ui.editingRoundId === b.dataset.dr) {
              state.ui.editingRoundId = null;
            }
            logAudit('remove_round',b.dataset.dr); 
            saveState(); 
            syncToFirestore(); 
            renderSetup(root);
          }
        });
        
        if(isAdmin){
          // Cancel edit handler
          const cancelBtn = document.getElementById('rCancelEdit');
          if(cancelBtn) {
            cancelBtn.onclick = () => {
              state.ui.editingRoundId = null;
              saveState();
              renderSetup(root);
            };
          }
          
          // Save/Update handler
          document.getElementById('rSave').onclick=()=>{ 
            const n=document.getElementById('rName').value.trim(); 
            const t=document.getElementById('rType').value.trim(); 
            const s=document.getElementById('rSub').value.trim(); 
            let w=+document.getElementById('rWeight').value||0; 
            let m=+document.getElementById('rMax').value||10; 
            
            // Get selected categories
            const selectedCategories = Array.from(document.querySelectorAll('.rCatCheck:checked')).map(cb => cb.value);
            
            if(!n) { alert('Round name is required'); return; }
            if(m>10)m=10; 
            if(m<0)m=0; 
            
            const roundData = {
              name:n,
              type:t,
              sub:s,
              weight:w,
              maxPoints:m,
              eligibleCategories: selectedCategories.length > 0 ? selectedCategories : null
            };
            
            if(editingRoundId) {
              // Update existing round
              const roundIndex = state.rounds.findIndex(r => r.id === editingRoundId);
              if(roundIndex !== -1) {
                state.rounds[roundIndex] = {...state.rounds[roundIndex], ...roundData};
                logAudit('update_round',`${n} (categories: ${selectedCategories.length > 0 ? selectedCategories.join(', ') : 'All'})`);
              }
              state.ui.editingRoundId = null;
            } else {
              // Add new round
              state.rounds.push({
                id:uid(),
                ...roundData
              }); 
              logAudit('add_round',`${n} (categories: ${selectedCategories.length > 0 ? selectedCategories.join(', ') : 'All'})`);
            }
            
            saveState(); 
            syncToFirestore(); 
            renderSetup(root); 
          };
        }
      }
    }

    // Show assignment dialog for a judge
    function showAssignmentDialog(judge, root) {
      const allCategories = [...new Set(state.contestants.map(c => c.category).filter(Boolean))];
      const allRounds = state.rounds;
      
      const currentCategories = judge.assignedCategories || [];
      const currentRounds = judge.assignedRounds || [];
      
      const dialogHtml = `
        <div style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;display:flex;align-items:center;justify-content:center" id="assignmentDialog">
          <div class="card" style="max-width:600px;width:90%;max-height:80vh;overflow-y:auto">
            <h3>Assign Categories & Rounds to ${judge.name}</h3>
            <div class="spacer"></div>
            
            <h4>Categories</h4>
            <p class="muted" style="font-size:12px">Select which categories this judge can score (leave empty for all)</p>
            <div id="categoryCheckboxes" style="max-height:200px;overflow-y:auto;border:1px solid var(--border);padding:12px;border-radius:8px">
              ${allCategories.length > 0 ? allCategories.map(cat => `
                <label style="display:block;margin-bottom:8px;cursor:pointer">
                  <input type="checkbox" value="${cat}" ${currentCategories.includes(cat) ? 'checked' : ''}>
                  <span style="margin-left:8px">${cat}</span>
                </label>
              `).join('') : '<p class="muted">No categories available</p>'}
            </div>
            
            <div class="spacer"></div>
            
            <h4>Rounds</h4>
            <p class="muted" style="font-size:12px">Select which rounds this judge can score (leave empty for all)</p>
            <div id="roundCheckboxes" style="max-height:200px;overflow-y:auto;border:1px solid var(--border);padding:12px;border-radius:8px">
              ${allRounds.length > 0 ? allRounds.map(round => {
                const roundDisplay = `${round.name}${round.sub ? ' ‚Äî ' + round.sub : ''}`;
                return `
                <label style="display:block;margin-bottom:8px;cursor:pointer">
                  <input type="checkbox" value="${round.id}" ${currentRounds.includes(round.id) ? 'checked' : ''}>
                  <span style="margin-left:8px">${roundDisplay}</span>
                </label>
              `}).join('') : '<p class="muted">No rounds available</p>'}
            </div>
            
            <div class="spacer"></div>
            
            <div class="row" style="gap:12px;justify-content:flex-end">
              <button class="btn" id="cancelAssignment">Cancel</button>
              <button class="btn primary" id="saveAssignment">Save Assignments</button>
            </div>
          </div>
        </div>
      `;
      
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = dialogHtml;
      document.body.appendChild(tempDiv.firstElementChild);
      
      document.getElementById('cancelAssignment').onclick = () => {
        document.getElementById('assignmentDialog').remove();
      };
      
      document.getElementById('saveAssignment').onclick = () => {
        const selectedCategories = Array.from(document.querySelectorAll('#categoryCheckboxes input:checked')).map(cb => cb.value);
        const selectedRounds = Array.from(document.querySelectorAll('#roundCheckboxes input:checked')).map(cb => cb.value);
        
        judge.assignedCategories = selectedCategories;
        judge.assignedRounds = selectedRounds;
        
        logAudit('assign_judge', {judgeId: judge.id, judgeName: judge.name, categories: selectedCategories, rounds: selectedRounds});
        saveState();
        syncToFirestore();
        
        document.getElementById('assignmentDialog').remove();
        renderSetup(root);
      };
      
      // Close on background click
      document.getElementById('assignmentDialog').onclick = (e) => {
        if(e.target.id === 'assignmentDialog') {
          document.getElementById('assignmentDialog').remove();
        }
      };
    }

    function renderScoring(root){
      const judgeOptions=state.judges.map(j=>`<option value='${j.id}'>${j.name}</option>`).join('');
      const lockedId=state.me.judgeId; const lock=state.me.role==='judge'&&lockedId;
      
      // Get unique categories from contestants, filtered by judge's assignments if locked
      let categories = [...new Set(state.contestants.map(c => c.category).filter(Boolean))];
      if(lock) {
        const currentJudge = state.judges.find(j => j.id === lockedId);
        const assignedCategories = currentJudge?.assignedCategories || [];
        if(assignedCategories.length > 0) {
          categories = categories.filter(cat => assignedCategories.includes(cat));
        }
      }
      const categoryOptions = `<option value="">All Categories</option>` + categories.map(cat => `<option value='${cat}'>${cat}</option>`).join('');
      
      root.innerHTML=`
        <div class="card sticky">
          <div class="row-between">
            <div class="row">
              <h3>Judge Scoring</h3>
              <span class="pill">Role: ${state.me.role||'‚Äî'}</span>
              <div class="pill">User: ${state.me.name||'‚Äî'}</div>
            </div>
            <div class="row">
              <button class="btn" id="sOut">Sign Out</button>
              <button class="btn" id="toAdmin">Sign In as Admin</button>
            </div>
          </div>
          <div class="spacer"></div>
          <div class="row" style="gap:16px;align-items:flex-end;flex-wrap:wrap">
            <div style="flex:1;min-width:200px">
              <label>Judge</label>
              <select id="sJudge" ${lock?'disabled':''}>${judgeOptions}</select>
            </div>
            <div style="flex:1;min-width:200px">
              <label>Round</label>
              <select id="sRound">${state.rounds.filter(r => {
                // If viewing as admin/non-judge, show all rounds
                if(!lock) return true;
                // If judge has assignments, filter by them
                const judge = state.judges.find(j => j.id === lockedId);
                const assignedRounds = judge?.assignedRounds || [];
                return assignedRounds.length === 0 || assignedRounds.includes(r.id);
              }).map(r=>`<option value='${r.id}'>${r.name} ${r.sub?('‚Äî '+r.sub):''} (${r.type||'‚Äì'}) ‚Ä¢ Max ${Math.min(r.maxPoints||10,10)}</option>`).join('')}</select>
            </div>
            <div style="flex:1;min-width:200px">
              <label>Category Filter</label>
              <select id="sCategoryFilter">${categoryOptions}</select>
            </div>
            <div class="muted" style="font-size:12px;white-space:nowrap" id="contestantCount">Contestants: ${state.contestants.length}</div>
          </div>
        </div>
        
        <div class="spacer"></div>
        
        <div class="card">
          <div class="row-between">
            <h3>Enter Scores</h3>
            <div class="muted" id="sMessage">Scores auto-save. Submit to confirm.</div>
          </div>
          <div class="spacer"></div>
          <table>
            <thead><tr><th>#</th><th>Name</th><th>Category</th><th style="width:110px">Score (0‚Äì10)</th><th>Notes</th></tr></thead>
            <tbody id="sBody"></tbody>
          </table>
          <div class="spacer"></div>
          <div style="text-align:right">
            <button class="btn primary" id="sSubmit">Submit Scores</button>
          </div>
        </div>`;

      document.getElementById('sOut').onclick=signOut;
      document.getElementById('toAdmin').onclick=()=>goToLogin('admin');

      const jSel=document.getElementById('sJudge'); 
      const rSel=document.getElementById('sRound'); 
      const catFilter=document.getElementById('sCategoryFilter');
      
      // Restore previous selections from state
      if(!state.ui.scoringView) state.ui.scoringView = {judgeId:'',roundId:'',category:''};
      if(lock) {
        jSel.value=lockedId;
        state.ui.scoringView.judgeId = lockedId;
      } else if(state.ui.scoringView.judgeId && state.judges.find(j => j.id === state.ui.scoringView.judgeId)) {
        jSel.value = state.ui.scoringView.judgeId;
      }
      if(state.ui.scoringView.roundId && state.rounds.find(r => r.id === state.ui.scoringView.roundId)) {
        rSel.value = state.ui.scoringView.roundId;
      }
      if(state.ui.scoringView.category) {
        catFilter.value = state.ui.scoringView.category;
      }
      
      jSel.onchange=()=>{ 
        if(lock) {
          jSel.value=lockedId;
        } else {
          state.ui.scoringView.judgeId = jSel.value;
          saveState();
        }
        fill(); 
      }; 
      rSel.onchange=()=>{
        state.ui.scoringView.roundId = rSel.value;
        saveState();
        fill();
      }; 
      catFilter.onchange=()=>{
        state.ui.scoringView.category = catFilter.value;
        saveState();
        fill();
      };
      fill();

      function fill(){
        const j=jSel.value, r=rSel.value; 
        const selectedCategory = catFilter.value;
        const round=state.rounds.find(x=>x.id===r); 
        const body=document.getElementById('sBody');
        const submissionKey=`${j}|${r}`;
        const isSubmitted=!!state.submissions[submissionKey];
        const disabledAttr=isSubmitted?' disabled':'';
        
        // Filter contestants based on round's eligible categories
        let eligibleContestants = [...state.contestants];
        if(round && round.eligibleCategories && round.eligibleCategories.length > 0) {
          eligibleContestants = eligibleContestants.filter(c => 
            round.eligibleCategories.includes(c.category)
          );
        }
        
        // Filter by judge's assigned categories (if any)
        const currentJudge = state.judges.find(judge => judge.id === j);
        const assignedCategories = currentJudge?.assignedCategories || [];
        if(assignedCategories.length > 0) {
          eligibleContestants = eligibleContestants.filter(c => 
            assignedCategories.includes(c.category)
          );
        }
        
        // Apply category filter from dropdown
        if(selectedCategory) {
          eligibleContestants = eligibleContestants.filter(c => c.category === selectedCategory);
        }
        
        // Update contestant count display
        const totalContestants = state.contestants.length;
        const eligibleCount = eligibleContestants.length;
        const countDisplay = document.getElementById('contestantCount');
        if(countDisplay) {
          let countText = `Showing: <strong>${eligibleCount}</strong>`;
          if(selectedCategory) {
            countText += ` (${selectedCategory})`;
          } else if(round && round.eligibleCategories && round.eligibleCategories.length > 0) {
            countText += ` (${round.eligibleCategories.join(', ')})`;
          } else {
            countText += ` (All)`;
          }
          countDisplay.innerHTML = `<span style="font-size:12px">${countText}</span>`;
        }
        
        const rows=eligibleContestants.sort((a,b)=>(a.number??9999)-(b.number??9999)).map(c=>{ 
          const key=scoreKey(j,c.id,r); 
          const cur=state.scores[key]||{score:'',notes:''}; 
          return `<tr><td>${c.number??''}</td><td>${c.name}</td><td>${c.category||''}</td><td><input data-score='${key}' type='text' inputmode='numeric' pattern='[0-9]*' maxlength='2' style='width:60px' value='${cur.score}'${disabledAttr}/></td><td><input data-notes='${key}' placeholder='Optional notes' value="${htmlAttrEscape(cur.notes||'')}"${disabledAttr}/></td></tr>`; 
        }).join('');
        
        body.innerHTML=rows||`<tr><td colspan="5" class="muted">${selectedCategory ? `No contestants in ${selectedCategory} category` : (round && round.eligibleCategories && round.eligibleCategories.length > 0 ? 'No contestants in eligible categories' : 'Add contestants in Setup')}</td></tr>`;
        
        if(!isSubmitted){
          body.querySelectorAll('input[data-score]').forEach(inp=>{ 
            inp.onchange=()=>{ 
              const key=inp.dataset.score; 
              const inputVal=inp.value.trim();
              
              // Validate input
              if(inputVal === '') {
                // Allow empty - will be treated as 0 on submit
                state.scores[key]=state.scores[key]||{}; 
                state.scores[key].score='';
                saveState(); 
                syncToFirestore();
                return;
              }
              
              const v=parseInt(inputVal);
              if(isNaN(v)) {
                alert('Please enter a valid number between 0 and 10');
                inp.value=state.scores[key]?.score || '';
                return;
              }
              
              if(v < 0 || v > 10) {
                alert('Score must be between 0 and 10');
                inp.value=state.scores[key]?.score || '';
                return;
              }
              
              state.scores[key]=state.scores[key]||{}; 
              state.scores[key].score=v; 
              const [jId,cId,rId]=key.split('|'); 
              const judge=state.judges.find(j=>j.id===jId); 
              const contestant=state.contestants.find(c=>c.id===cId); 
              const round=state.rounds.find(r=>r.id===rId); 
              logAudit('set_score',`${judge?.name} ‚Üí ${contestant?.name} (${round?.name}): ${v}`); 
              saveState(); 
              syncToFirestore(); 
              inp.value=v;
            }; 
          });
          body.querySelectorAll('input[data-notes]').forEach(inp=>{ inp.onchange=()=>{ const key=inp.dataset.notes; state.scores[key]=state.scores[key]||{}; state.scores[key].notes=inp.value; saveState(); syncToFirestore(); }; });
        }
        
        // Update submit button
        const submitBtn=document.getElementById('sSubmit');
        const messageEl=document.getElementById('sMessage');
        if(isSubmitted){
          submitBtn.textContent='‚úì Submitted';
          submitBtn.disabled=true;
          submitBtn.style.opacity='0.6';
          submitBtn.style.cursor='not-allowed';
          messageEl.innerHTML='<span style="color:var(--good)">‚úì Scores submitted and locked. Contact admin to unlock.</span>';
        } else {
          submitBtn.textContent='Submit Scores';
          submitBtn.disabled=false;
          submitBtn.style.opacity='1';
          submitBtn.style.cursor='pointer';
          messageEl.textContent='Scores auto-save. Submit to confirm.';
        }
      }

      document.getElementById('sSubmit').onclick=()=>{ 
        const judgeId = jSel.value;
        const roundId = rSel.value;
        const selectedCategory = catFilter.value;
        const key = `${judgeId}|${roundId}`;
        const round = state.rounds.find(x=>x.id===roundId);
        
        // Get the same filtered list that's being displayed
        let eligibleContestants = [...state.contestants];
        
        // Filter by round's eligible categories
        if(round && round.eligibleCategories && round.eligibleCategories.length > 0) {
          eligibleContestants = eligibleContestants.filter(c => 
            round.eligibleCategories.includes(c.category)
          );
        }
        
        // Apply category filter from dropdown
        if(selectedCategory) {
          eligibleContestants = eligibleContestants.filter(c => c.category === selectedCategory);
        }
        
        // Check if there are no contestants to score
        if(eligibleContestants.length === 0) {
          alert('No contestants to score in the current selection.');
          return;
        }
        
        // Check if any scores have been entered for DISPLAYED contestants only
        let filledScores = 0;
        let emptyScores = 0;
        
        eligibleContestants.forEach(contestant => {
          const scoreKey = `${judgeId}|${contestant.id}|${roundId}`;
          const scoreData = state.scores[scoreKey];
          
          if(scoreData && scoreData.score !== '' && scoreData.score !== null && scoreData.score !== undefined) {
            filledScores++;
          } else {
            emptyScores++;
          }
        });
        
        // Only show error if there are empty scores in the DISPLAYED list
        if(emptyScores > 0) {
          if(filledScores === 0) {
            alert('Please enter at least one score before submitting.');
            return;
          }
          
          const totalDisplayed = eligibleContestants.length;
          if(!confirm(`You have only scored ${filledScores} out of ${totalDisplayed} displayed contestants.\n\nEmpty scores will be counted as 0.\n\nDo you want to submit anyway?`)) {
            return;
          }
        }
        
        // All displayed contestants are scored - proceed without warning
        // Submit
        state.submissions[key] = new Date().toISOString(); 
        logAudit('submit_scores', key); 
        saveState(); 
        syncToFirestore(true); 
        alert('Scores submitted and locked.'); 
        fill(); // Refresh to show locked state
      };
    }

    function getRoundScore(contestantId, round){
      const vals=state.judges.map(j=> state.scores[scoreKey(j.id,contestantId,round.id)]).filter(Boolean).map(s=>+s.score||0);
      if(!vals.length) return null; const total=vals.reduce((a,b)=>a+b,0);
      const agg=state.settings.roundAggregation==='sum'?total: total/vals.length; return {value:agg, judgesCount:vals.length};
    }

    function renderRoundResults(root){
      root.innerHTML=`
        <div class="card sticky"><div class="row-between"><div class="row" style="gap:16px"><div><label>Round</label><select id="rrRound">${state.rounds.map(r=>`<option value='${r.id}'>${r.name}</option>`).join('')}</select></div><div><label>Sort by</label><select id="rrSort"><option value='desc'>Highest first</option><option value='asc'>Lowest first</option><option value='num'>Contestant #</option><option value='name'>Name</option></select></div></div><div class="row"><button class="btn" id="rrCsv">Download CSV</button><button class="btn" id="rrOut">Sign Out</button><button class="btn" id="rrAdmin">Sign In as Admin</button><button class="btn" id="rrJudge">Sign In as Judge</button></div></div></div>
        <div class="spacer"></div>
        <div class="card"><table><thead><tr><th>#</th><th>Name</th><th>Category</th><th>Score (${state.settings.roundAggregation})</th><th>Judges</th></tr></thead><tbody id="rrBody"></tbody></table></div>`;
      document.getElementById('rrOut').onclick=signOut; document.getElementById('rrAdmin').onclick=()=>goToLogin('admin'); document.getElementById('rrJudge').onclick=()=>goToLogin('judge');
      const rSel=document.getElementById('rrRound'); const sSel=document.getElementById('rrSort'); const body=document.getElementById('rrBody');
      function draw(){ const r=state.rounds.find(x=>x.id===rSel.value); let rows=state.contestants.map(ct=>({ct,rs:getRoundScore(ct.id,r)})); const m=sSel.value; if(m==='desc') rows.sort((a,b)=>(b.rs?.value||-1)-(a.rs?.value||-1)); if(m==='asc') rows.sort((a,b)=>(a.rs?.value?? 1e9)-(b.rs?.value??1e9)); if(m==='num') rows.sort((a,b)=>(a.ct.number??9999)-(b.ct.number??9999)); if(m==='name') rows.sort((a,b)=>a.ct.name.localeCompare(b.ct.name)); body.innerHTML=rows.map(({ct,rs})=>`<tr><td>${ct.number??''}</td><td>${ct.name}</td><td>${ct.category||''}</td><td>${rs?rs.value.toFixed(2):'<span class=\"muted\">‚Äî</span>'}</td><td>${rs?rs.judgesCount:0}/${state.judges.length}</td></tr>`).join(''); }
      rSel.onchange=draw; sSel.onchange=draw; draw();
      document.getElementById('rrCsv').onclick=()=>{ const r=state.rounds.find(x=>x.id===rSel.value); const rows=[["Contestant #","Name","Category",`Score (${state.settings.roundAggregation})`,`Judges`]]; state.contestants.forEach(ct=>{ const rs=getRoundScore(ct.id,r); rows.push([ct.number??'',ct.name,ct.category||'',rs?rs.value.toFixed(2):'',rs?rs.judgesCount:0]); }); download(`${r.name}_round_results.csv`, toCSV(rows)); };
    }

    function renderFinalResults(root){
      const totalW=sumWeights();
      
      // State for sorting and filtering
      if(!state.ui.finalResults) state.ui.finalResults = {sortColumn: 'total', sortDir: 'desc', filter: ''};
      const sortState = state.ui.finalResults;
      
      root.innerHTML=`
        <div class="card sticky">
          <div class="row-between">
            <div class="row" style="gap:16px">
              <div class="pill ${Math.abs(totalW-100)<=0.5?'ok':'warn'}">Total weight: ${totalW||0}%</div>
              <div class="muted">Weights are normalized if not exactly 100%</div>
            </div>
            <div class="row">
              <button class="btn" id="frCsv">Download CSV</button>
              <button class="btn" id="frOut">Sign Out</button>
              <button class="btn" id="frAdmin">Sign In as Admin</button>
              <button class="btn" id="frJudge">Sign In as Judge</button>
            </div>
          </div>
          <div class="spacer"></div>
          <div class="row" style="gap:12px">
            <input id="frFilter" placeholder="üîç Filter by name, number, or category..." value="${sortState.filter}" style="flex:1;font-size:14px">
            <button class="btn" id="frClearFilter">Clear</button>
          </div>
        </div>
        <div class="spacer"></div>
        <div class="card">
          <div style="overflow-x:auto">
            <table style="width:100%;min-width:max-content">
              <thead>
                <tr>
                  <th style="cursor:pointer" data-sort="number"># ${sortState.sortColumn==='number'?(sortState.sortDir==='asc'?'‚Üë':'‚Üì'):''}</th>
                  <th style="cursor:pointer" data-sort="name">Name ${sortState.sortColumn==='name'?(sortState.sortDir==='asc'?'‚Üë':'‚Üì'):''}</th>
                  <th style="cursor:pointer" data-sort="category">Category ${sortState.sortColumn==='category'?(sortState.sortDir==='asc'?'‚Üë':'‚Üì'):''}</th>
                  ${state.rounds.map((r,i)=>`<th style="cursor:pointer" data-sort="round${i}">${r.name} ${sortState.sortColumn===`round${i}`?(sortState.sortDir==='asc'?'‚Üë':'‚Üì'):''}</th>`).join('')}
                  <th style="cursor:pointer" data-sort="total">Total ${sortState.sortColumn==='total'?(sortState.sortDir==='asc'?'‚Üë':'‚Üì'):''}</th>
                </tr>
              </thead>
              <tbody id="frBody"></tbody>
            </table>
          </div>
        </div>`;
      
      document.getElementById('frOut').onclick=signOut; 
      document.getElementById('frAdmin').onclick=()=>goToLogin('admin'); 
      document.getElementById('frJudge').onclick=()=>goToLogin('judge');
      
      // Filter functionality
      const filterInput = document.getElementById('frFilter');
      filterInput.oninput = (e) => {
        sortState.filter = e.target.value;
        saveState();
        renderFinalResultsTable();
      };
      
      document.getElementById('frClearFilter').onclick = () => {
        sortState.filter = '';
        filterInput.value = '';
        saveState();
        renderFinalResultsTable();
      };
      
      // Sorting functionality
      document.querySelectorAll('th[data-sort]').forEach(th => {
        th.onclick = () => {
          const col = th.dataset.sort;
          if(sortState.sortColumn === col) {
            sortState.sortDir = sortState.sortDir === 'asc' ? 'desc' : 'asc';
          } else {
            sortState.sortColumn = col;
            sortState.sortDir = 'desc';
          }
          saveState();
          renderFinalResults(root);
        };
      });
      
      function compute(ct){ 
        const tot=sumWeights()||1; 
        let total=0; 
        const parts=[]; 
        state.rounds.forEach(r=>{ 
          const rs=getRoundScore(ct.id,r); 
          const max=r.maxPoints||10; 
          const pct=rs?(rs.value/max)*100:0; 
          const w=(r.weight||0)/tot; 
          const contrib=pct*w; 
          parts.push(contrib); 
          total+=contrib; 
        }); 
        return {total,parts}; 
      }
      
      function renderFinalResultsTable() {
        let rows = state.contestants.map(ct=>({ct,fr:compute(ct)}));
        
        // Apply filter
        if(sortState.filter) {
          const filterLower = sortState.filter.toLowerCase();
          rows = rows.filter(({ct}) => {
            return ct.name.toLowerCase().includes(filterLower) ||
                   (ct.category||'').toLowerCase().includes(filterLower) ||
                   String(ct.number||'').includes(filterLower);
          });
        }
        
        // Apply sorting
        rows.sort((a,b) => {
          let valA, valB;
          
          if(sortState.sortColumn === 'number') {
            valA = a.ct.number ?? 9999;
            valB = b.ct.number ?? 9999;
          } else if(sortState.sortColumn === 'name') {
            valA = a.ct.name.toLowerCase();
            valB = b.ct.name.toLowerCase();
          } else if(sortState.sortColumn === 'category') {
            valA = (a.ct.category||'').toLowerCase();
            valB = (b.ct.category||'').toLowerCase();
          } else if(sortState.sortColumn === 'total') {
            valA = a.fr.total;
            valB = b.fr.total;
          } else if(sortState.sortColumn.startsWith('round')) {
            const roundIndex = parseInt(sortState.sortColumn.replace('round',''));
            valA = a.fr.parts[roundIndex] || 0;
            valB = b.fr.parts[roundIndex] || 0;
          } else {
            valA = a.fr.total;
            valB = b.fr.total;
          }
          
          if(typeof valA === 'string') {
            return sortState.sortDir === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
          } else {
            return sortState.sortDir === 'asc' ? valA - valB : valB - valA;
          }
        });
        
        const body = document.getElementById('frBody');
        body.innerHTML = rows.map(({ct,fr})=>`<tr><td>${ct.number??''}</td><td>${ct.name}</td><td>${ct.category||''}</td>${fr.parts.map(v=>`<td>${v.toFixed(2)}</td>`).join('')}<td><strong>${fr.total.toFixed(2)}</strong></td></tr>`).join('') || '<tr><td colspan="100" style="text-align:center" class="muted">No results match filter</td></tr>';
      }
      
      renderFinalResultsTable();
      
      document.getElementById('frCsv').onclick=()=>{ 
        const head=["Contestant #","Name","Category",...state.rounds.map(r=>r.name),"Total (weighted)"]; 
        const out=[head]; 
        let rows = state.contestants.map(ct=>({ct,fr:compute(ct)}));
        rows.forEach(({ct,fr})=> out.push([ct.number??'',ct.name,ct.category||'',...fr.parts.map(v=>v.toFixed(2)),fr.total.toFixed(2)])); 
        download('final_results_weighted.csv', toCSV(out)); 
      };
    }

    function renderSettings(root){
      root.innerHTML=`
        <div class="grid col-2">
          <div class="card">
            <h3>Login</h3>
            <div class="spacer"></div>
            <label for="meName">Your name</label>
            <input id="meName" value="${state.me.name||''}" placeholder="e.g., Judge Priya" aria-label="Your name">
            <div class="spacer"></div>
            <label for="meRole">Role</label>
            <select id="meRole" aria-label="Select your role">
              <option value="admin" ${state.me.role==='admin'?'selected':''}>Admin</option>
              <option value="judge" ${state.me.role==='judge'?'selected':''}>Judge</option>
            </select>
            <div class="spacer"></div>
            <div class="row">
              <button class="btn" id="goAdmin" aria-label="Switch to admin mode">Go Admin</button>
              <button class="btn" id="goJudge" aria-label="Switch to judge mode">Go Judge</button>
              <button class="btn" id="goLogout" aria-label="Sign out">Sign Out</button>
            </div>
          </div>

          <div class="card">
            <h3>Cloud Sync (Firestore)</h3>
            <div class="spacer"></div>
            <div class="pill ${state.cloud.enabled?'ok':'warn'}">${state.cloud.enabled?'‚úì Enabled':'‚óã Disabled'}</div>
            <div class="spacer"></div>
            
            <!-- Quick Connect Option -->
            <div style="background:rgba(34,211,238,0.1);padding:12px;border-radius:8px;border:1px solid rgba(34,211,238,0.3);margin-bottom:12px">
              <h4 style="margin:0 0 8px 0;font-size:14px">‚ö° Quick Connect (Recommended)</h4>
              <p class="muted" style="font-size:12px;margin:0 0 8px 0">Just enter the event code shared by the admin</p>
              <div class="row">
                <input id="quickEventCode" placeholder="e.g., pageant2025" style="flex:1" aria-label="Enter event code to connect" aria-required="true">
                <button class="btn primary" id="quickConnectBtn" aria-label="Connect to event">Connect</button>
              </div>
            </div>
            
            <!-- Manual Setup Option -->
            <details>
              <summary style="cursor:pointer;font-weight:500;margin-bottom:8px">üîß Manual Setup (Admin Only - First Time)</summary>
              <div class="spacer"></div>
              <label for="fbConfig">Firebase Config JSON</label>
              <textarea id="fbConfig" placeholder='{"apiKey":"...","authDomain":"...","projectId":"...","storageBucket":"...","messagingSenderId":"...","appId":"..."}'>${state.cloud.firebaseConfig?JSON.stringify(state.cloud.firebaseConfig,null,2):''}</textarea>
              <div class="spacer"></div>
              <label for="eventCode">Event Code (create a unique code for this event)</label>
              <div class="row">
                <input id="eventCode" value="${state.cloud.eventCode||''}" placeholder="e.g., pageant2025-gWf7kX2" style="flex:1" aria-label="Event code">
                <button class="btn" id="generateCodeBtn" title="Generate random secure code" aria-label="Generate random event code">üé≤ Generate</button>
              </div>
              <div class="spacer"></div>
              <div class="muted" style="font-size:11px;padding:8px;background:rgba(251,191,36,0.1);border-radius:6px;border:1px solid rgba(251,191,36,0.3)">
                ‚ö†Ô∏è <strong>Security Note:</strong> Use a unique, hard-to-guess code. Share only with trusted participants.
              </div>
              <div class="spacer"></div>
              <div class="row">
                <button class="btn primary" id="enableCloudBtn">${state.cloud.enabled?'Reconnect':'Enable Cloud & Save Config'}</button>
              </div>
            </details>
            
            <div class="spacer"></div>
            <div class="row" style="margin-top:12px">
              <button class="btn" id="syncNowBtn" ${state.cloud.enabled?'':'disabled'} aria-label="Sync data now">Sync Now</button>
              <button class="btn bad" id="disableCloudBtn" ${state.cloud.enabled?'':'disabled'} aria-label="Disable cloud sync">Disable</button>
            </div>
            <div class="spacer"></div>
            <label class="row"><input type="checkbox" id="autoSyncChk" ${state.cloud.autoSync?'checked':''} aria-label="Enable automatic syncing"/> Auto-sync</label>
            <div class="spacer"></div>
            <div class="muted" style="font-size:12px">Cloud stores data in Firestore under <span class="mono">events/{eventCode}</span>. All devices with same event code share data in real-time.</div>
          </div>

          <div class="card">
            <h3>üîí Admin Authentication</h3>
            <div class="spacer"></div>
            <div style="background:rgba(34,211,238,0.1);padding:16px;border-radius:8px;border:1px solid rgba(34,211,238,0.3)">
              <h4 style="margin:0 0 8px 0;font-size:14px">Secure Firebase Authentication</h4>
              <p class="muted" style="font-size:12px;margin:0">Admin accounts are managed through Firebase Authentication. Admins must sign in with email and password on the login page.</p>
              <div class="spacer"></div>
              <div class="muted" style="font-size:11px">
                <strong>To create admin accounts:</strong><br>
                1. Go to Firebase Console ‚Üí Authentication<br>
                2. Enable Email/Password provider<br>
                3. Add new users manually<br>
                4. Share credentials securely with admins
              </div>
            </div>
          </div>
          
          <div class="card">
            <h3>üîê Event Password (Second Layer Security)</h3>
            <div class="spacer"></div>
            <div class="pill ${state.settings.eventPasswordHash?'ok':'warn'}">${state.settings.eventPasswordHash?'‚úì Password Set':'‚óã No Password'}</div>
            <div class="spacer"></div>
            <p class="muted" style="font-size:12px">Set a password that users must enter AFTER connecting with the event code. This adds an extra layer of security.</p>
            <div class="spacer"></div>
            <label for="eventPassword">Event Password</label>
            <div class="row">
              <input id="eventPassword" type="password" placeholder="Enter new event password" style="flex:1" aria-label="Event password" aria-describedby="eventPasswordHelp">
              <button class="btn primary" id="setEventPasswordBtn" aria-label="Set event password">Set Password</button>
            </div>
            <span id="eventPasswordHelp" class="sr-only">Optional password that judges must enter after connecting with event code</span>
            <div class="spacer"></div>
            ${state.settings.eventPasswordHash?`
              <button class="btn bad" id="removeEventPasswordBtn">Remove Password</button>
              <div class="spacer"></div>
            `:''}
            <div class="muted" style="font-size:11px;background:rgba(16,185,129,0.1);padding:8px;border-radius:6px;border:1px solid rgba(16,185,129,0.3)">
              ‚ÑπÔ∏è Users will need both the event code AND this password to access the event.
            </div>
          </div>

          <div class="card">
            <h3>Scoring Aggregation</h3>
            <div class="spacer"></div>
            <label>Method</label>
            <select id="aggMethod">
              <option value="average" ${state.settings.roundAggregation==='average'?'selected':''}>Average</option>
              <option value="sum" ${state.settings.roundAggregation==='sum'?'selected':''}>Sum</option>
            </select>
            <div class="spacer"></div>
            <button class="btn" id="applyAgg">Apply</button>
          </div>
                1. Go to Firebase Console ‚Üí Authentication<br>
                2. Add users with email/password<br>
                3. Share credentials securely with admins
              </div>
            </div>
            ${fb.auth && fb.auth.currentUser ? `
              <div class="spacer"></div>
              <div style="background:rgba(16,185,129,0.1);padding:12px;border-radius:8px;border:1px solid rgba(16,185,129,0.3)">
                <div class="pill ok" style="font-size:12px">‚úì Currently signed in as: ${fb.auth.currentUser.email}</div>
              </div>
            ` : ''}
          </div>

          <div class="card" style="grid-column:span 2">
            <div class="row-between">
              <h3>Audit Log</h3>
              <button class="btn" id="auditCsv">Download CSV</button>
            </div>
            <div class="spacer"></div>
            <div class="muted" style="font-size:12px;margin-bottom:8px">
              üìç <strong>Storage Locations:</strong><br>
              ‚Ä¢ Local: Browser localStorage (key: <span class="mono">pageant_scoring_v2</span>)<br>
              ${state.cloud.enabled ? `‚Ä¢ Cloud: Firestore at <span class="mono">events/${state.cloud.eventCode}/audit</span> (subcollection)` : '‚Ä¢ Cloud: Not enabled'}
            </div>
            <table>
              <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Details</th></tr></thead>
              <tbody id="auditBody"></tbody>
            </table>
          </div>
        </div>`;
      
      // Login controls
      document.getElementById('meName').onchange=e=>{state.me.name=e.target.value; saveState();};
      document.getElementById('meRole').onchange=e=>{state.me.role=e.target.value; saveState(); render();};
      document.getElementById('goAdmin').onclick=()=>signInAdmin(state.me.name||'Admin');
      document.getElementById('goJudge').onclick=()=>signInJudge(state.me.name||'Judge');
      document.getElementById('goLogout').onclick=signOut;
      
      // Cloud controls
      
      // Generate secure event code
      document.getElementById('generateCodeBtn').onclick=()=>{
        const randomPart = Math.random().toString(36).slice(2,9) + Math.random().toString(36).slice(2,9);
        const eventName = 'pageant2025';
        const secureCode = `${eventName}-${randomPart}`;
        document.getElementById('eventCode').value = secureCode;
      };
      
      // Quick Connect - fetch config from Firestore
      document.getElementById('quickConnectBtn').onclick=async ()=>{
        const eventCode = document.getElementById('quickEventCode').value.trim();
        if(!eventCode){ alert('Please enter an event code'); return; }
        
        try{
          // Use a temporary Firebase instance to fetch the config
          const tempConfig = state.cloud.firebaseConfig || {
            apiKey: "AIzaSyCiglilw9_NLuSZUMGgciEnIPwlZ8vVklI",
            authDomain: "womenfestival2025.firebaseapp.com",
            projectId: "womenfestival2025",
            storageBucket: "womenfestival2025.firebasestorage.app",
            messagingSenderId: "614457754654",
            appId: "1:614457754654:web:4c0ceeb3c29e38bc2bc1ea"
          };
          
          await initFirebase(tempConfig);
          
          // Fetch config from Firestore
          const configDoc = await fb.db.collection('event-configs').doc(eventCode).get();
          
          if(!configDoc.exists){
            alert('Event code not found. Ask the admin to set up cloud sync first using Manual Setup.');
            return;
          }
          
          const fetchedConfig = configDoc.data().firebaseConfig;
          
          // Reinitialize with fetched config if different
          if(JSON.stringify(fetchedConfig) !== JSON.stringify(tempConfig)){
            fb.app = null;
            await initFirebase(fetchedConfig);
          }
          
          state.cloud.enabled = true;
          state.cloud.eventCode = eventCode;
          state.cloud.firebaseConfig = fetchedConfig;
          saveState();
          
          await loadFromFirestore();
          startFirestoreListener();
          
          logAudit('cloud_enabled', {eventCode, method: 'quick_connect'});
          alert('Connected successfully! Data loaded from cloud.');
          render();
        }catch(err){
          alert('Failed to connect: ' + err.message);
          console.error(err);
        }
      };
      
      // Manual Setup - save config to Firestore
      document.getElementById('enableCloudBtn').onclick=async ()=>{
        const configText = document.getElementById('fbConfig').value.trim();
        const eventCode = document.getElementById('eventCode').value.trim();
        
        if(!configText){ alert('Please paste Firebase config JSON'); return; }
        if(!eventCode){ alert('Please enter an event code'); return; }
        
        try{
          const config = JSON.parse(configText);
          await initFirebase(config);
          state.cloud.enabled = true;
          state.cloud.eventCode = eventCode;
          state.cloud.firebaseConfig = config;
          saveState();
          
          // Save config to Firestore so others can use Quick Connect
          await fb.db.collection('event-configs').doc(eventCode).set({
            firebaseConfig: config,
            createdAt: new Date().toISOString(),
            createdBy: state.me.name || 'admin'
          });
          
          await loadFromFirestore();
          startFirestoreListener();
          await syncToFirestore(true);
          
          logAudit('cloud_enabled', {eventCode, method: 'manual_setup'});
          alert('Cloud sync enabled! Config saved. Share event code "' + eventCode + '" with others.');
          render();
        }catch(err){
          alert('Failed to enable cloud: ' + err.message);
          console.error(err);
        }
      };
      
      document.getElementById('syncNowBtn').onclick=async ()=>{
        if(!state.cloud.enabled) return;
        try{
          await syncToFirestore(true);
          alert('Synced successfully!');
        }catch(err){
          alert('Sync failed: ' + err.message);
        }
      };
      
      document.getElementById('disableCloudBtn').onclick=()=>{
        if(!confirm('Disable cloud sync? Local data will remain but won\'t sync.')) return;
        if(fb.unsub) { fb.unsub(); fb.unsub = null; }
        state.cloud.enabled = false;
        logAudit('cloud_disabled', null);
        saveState();
        render();
      };
      
      document.getElementById('autoSyncChk').onchange=e=>{
        state.cloud.autoSync = e.target.checked; 
        saveState();
      };
      
      // Event Password Management
      const setPasswordBtn = document.getElementById('setEventPasswordBtn');
      if(setPasswordBtn) {
        setPasswordBtn.onclick = async () => {
          const password = document.getElementById('eventPassword').value.trim();
          if(!password || password.length < 6) {
            alert('Event password must be at least 6 characters');
            return;
          }
          
          if(confirm('Set event password? Users will need this password to access the event after connecting with the event code.')) {
            const passwordHash = await hashPassword(password);
            state.settings.eventPasswordHash = passwordHash;
            
            // If already connected, mark as verified (admin setting it)
            if(state.cloud.enabled) {
              state.cloud.passwordVerified = true;
            }
            
            saveState();
            syncToFirestore();
            logAudit('event_password_set', {});
            alert('Event password set successfully! Share this password securely with authorized users.');
            document.getElementById('eventPassword').value = '';
            render();
          }
        };
      }
      
      const removePasswordBtn = document.getElementById('removeEventPasswordBtn');
      if(removePasswordBtn) {
        removePasswordBtn.onclick = () => {
          if(confirm('Remove event password? This will remove the second layer of security.')) {
            state.settings.eventPasswordHash = null;
            state.cloud.passwordVerified = true; // Allow access since no password required
            saveState();
            syncToFirestore();
            logAudit('event_password_removed', {});
            alert('Event password removed.');
            render();
          }
        };
      }
      
      // Format audit details to be human-readable
      function formatAuditDetails(action, details){
        if(!details) return '‚Äî';
        if(typeof details === 'string'){
          // Check if it's already formatted (contains arrows or colons from new format)
          if(details.includes('‚Üí') || (action === 'set_score' && details.includes(':'))){
            return details;
          }
          // Check if it's a score key format: judgeId|contestantId|roundId (old format)
          if(action === 'set_score' && details.includes('|')){
            const [jId, cId, rId] = details.split('|');
            const judge = state.judges.find(j=>j.id===jId);
            const contestant = state.contestants.find(c=>c.id===cId);
            const round = state.rounds.find(r=>r.id===rId);
            return `${judge?.name||'?'} ‚Üí ${contestant?.name||'?'} (${round?.name||'?'})`;
          }
          // Check if it's a submission key: judgeId|roundId
          if((action === 'submit_scores' || action === 'unlock_scores') && details.includes('|')){
            const [jId, rId] = details.split('|');
            const judge = state.judges.find(j=>j.id===jId);
            const round = state.rounds.find(r=>r.id===rId);
            return `${judge?.name||'?'} - ${round?.name||'?'}`;
          }
          return details;
        }
        return JSON.stringify(details);
      }
      
      // Audit log
      const body=document.getElementById('auditBody'); 
      body.innerHTML=state.audit.slice(-500).reverse().map(a=>`<tr><td>${a.ts}</td><td>${a.user}</td><td>${a.action}</td><td class='mono'>${formatAuditDetails(a.action, a.details)}</td></tr>`).join('')||`<tr><td colspan='4' class='muted'>No activity yet</td></tr>`;
      document.getElementById('auditCsv').onclick=()=>{ 
        const rows=[["ts","user","action","details"],...state.audit.map(a=>[a.ts,a.user,a.action,formatAuditDetails(a.action, a.details)])]; 
        download('audit.csv', toCSV(rows)); 
      };
      
      // Aggregation settings
      const applyAggBtn = document.getElementById('applyAgg');
      if(applyAggBtn) {
        applyAggBtn.onclick = () => {
          const method = document.getElementById('aggMethod').value;
          state.settings.roundAggregation = method;
          saveState();
          syncToFirestore();
          logAudit('aggregation_changed', {method});
          alert(`Aggregation method set to: ${method}`);
          render();
        };
      }
    }

    // --- Header buttons functions ---
    function download(filename, text){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([text],{type:'text/plain'})); a.download=filename; a.click(); }
    
    function exportJson(){ 
      download('pageant_scoring_data.json', JSON.stringify(state,null,2)); 
    }
    
    function exportCsv(){
      const rows=[["Judge","Contestant #","Contestant","Category","Round","Sub","Score","Notes"]];
      state.judges.forEach(j=>{ state.contestants.forEach(c=>{ state.rounds.forEach(r=>{ const s=state.scores[scoreKey(j.id,c.id,r.id)]; if(s){ rows.push([j.name,c.number??'',c.name,c.category||'',r.name,r.sub||'',s.score,s.notes||'']); } }); }); });
      download('all_scores.csv', toCSV(rows));
    }
    
    function clearScoresOnly(){
      if(confirm('Clear ALL scores and submissions but keep judges, contestants, and rounds?\n\nThis is useful for starting a new event with the same setup.')){
        state.scores = {};
        state.submissions = {};
        state.audit = state.audit || [];
        logAudit('clear_scores', 'All scores and submissions cleared for new event');
        saveState();
        syncToFirestore(true);
        alert('Scores and submissions cleared! Judges, contestants, and rounds are preserved.\n\nYou can now export this as a clean template for your new event.');
        render();
      }
    }
    
    function resetApp(){ 
      if(confirm('Clear all local data?')){ 
        localStorage.removeItem(LS_KEY); 
        location.reload(); 
      } 
    }
    
    function importJson(e){ 
      const f=e.target.files[0]; 
      if(!f) return; 
      const fr=new FileReader(); 
      fr.onload=()=>{ 
        try{ 
          const obj=JSON.parse(fr.result); 
          Object.assign(state,obj); 
          logAudit('import_json','Imported data from file'); 
          saveState(); 
          syncToFirestore(true); 
          render(); 
        }catch(err){ 
          alert('Import failed: '+err.message); 
        } 
      }; 
      fr.readAsText(f); 
    }

    // --- Self-tests ---
    function runTests(){ const out=[]; function test(n,fn){ try{fn(); out.push('‚úÖ '+n);}catch(e){out.push('‚ùå '+n+' -> '+e.message);} }
      // CSV escaping
      test('csvEscape quotes',()=>{ const got=toCSV([["a\"b",1]]); const exp='"a""b"'; const cell=got.split('\n')[0].split(',')[0]; if(cell!==exp) throw new Error('expected '+exp+' got '+cell); });
      test('toCSV newline wrap',()=>{ const got=toCSV([["x\ny",2]]); const cell=got.split('\n')[0].split(',')[0]; if(cell[0] !== '"' || cell.at(-1) !== '"') throw new Error('newline not quoted'); });
      test('csvEscape comma',()=>{ const got=toCSV([["a,b"]]); const cell=got.split('\n')[0].split(',')[0]; if(cell!== '"a,b"') throw new Error('comma not quoted'); });
      // key and aggregation logic
      test('scoreKey stable',()=>{ if(scoreKey('a','b','c')!=='a|b|c') throw new Error('bad key'); });
      test('round average',()=>{ const st={judges:[{id:'j1'},{id:'j2'}], contestants:[{id:'c1'}], rounds:[{id:'r1',maxPoints:10}], scores:{}}; st.scores[scoreKey('j1','c1','r1')]={score:8}; st.scores[scoreKey('j2','c1','r1')]={score:6}; const vals=[st.scores[scoreKey('j1','c1','r1')].score, st.scores[scoreKey('j2','c1','r1')].score]; const avg=(vals[0]+vals[1])/2; if(avg!==7) throw new Error('avg incorrect'); });
      document.getElementById('testOutput').innerHTML=out.map(x=>`<div class='${x.startsWith('‚úÖ')?'test-pass':'test-fail'}'>${x}</div>`).join(''); }
    document.getElementById('runTestsBtn').onclick=runTests;

    // --- Admin unlock functionality ---
    function populateUnlockSelects(){
      const judgeSelect=document.getElementById('unlockJudge');
      const roundSelect=document.getElementById('unlockRound');
      const submissionsList=document.getElementById('submissionsList');
      
      // Exit if elements don't exist (Developer Tools not visible)
      if(!judgeSelect || !roundSelect) return;
      
      judgeSelect.innerHTML='<option value="">Select Judge...</option>'+state.judges.map(j=>`<option value="${j.id}">${j.name}</option>`).join('');
      roundSelect.innerHTML='<option value="">Select Round...</option>'+state.rounds.map(r=>`<option value="${r.id}">${r.name}${r.sub?(' ‚Äî '+r.sub):''} (${r.type||'‚Äì'})${r.eligibleCategories && r.eligibleCategories.length > 0 ? ' ‚Ä¢ ' + r.eligibleCategories.join(', ') : ''}</option>`).join('');
      
      // Show current submissions
      if(submissionsList){
        const submissions=Object.keys(state.submissions).map(key=>{
          const [judgeId, roundId]=key.split('|');
          const judge=state.judges.find(j=>j.id===judgeId);
          const round=state.rounds.find(r=>r.id===roundId);
          const roundDisplay = round ? `${round.name}${round.sub?(' ‚Äî '+round.sub):''}${round.eligibleCategories && round.eligibleCategories.length > 0 ? ' (' + round.eligibleCategories.join(', ') + ')' : ''}` : 'Unknown';
          return `${judge?.name||'Unknown'} - ${roundDisplay}`;
        });
        if(submissions.length>0){
          submissionsList.innerHTML='<strong>Current submissions:</strong> '+submissions.join(', ');
        } else {
          submissionsList.innerHTML='<em>No submissions yet</em>';
        }
      }
    }
    
    function setupUnlockButton(){
      const unlockBtn=document.getElementById('unlockBtn');
      
      // Exit if button doesn't exist (Developer Tools not visible)
      if(!unlockBtn) return;
      
      unlockBtn.onclick=()=>{
        const judgeId=document.getElementById('unlockJudge').value;
        const roundId=document.getElementById('unlockRound').value;
        if(!judgeId || !roundId){
          alert('Please select both judge and round');
          return;
        }
        const key=`${judgeId}|${roundId}`;
        if(!state.submissions[key]){
          alert('This judge has not submitted scores for this round');
          return;
        }
        const judge=state.judges.find(j=>j.id===judgeId);
        const round=state.rounds.find(r=>r.id===roundId);
        const roundDisplay = round ? `${round.name}${round.sub?(' ‚Äî '+round.sub):''}${round.eligibleCategories && round.eligibleCategories.length > 0 ? ' (' + round.eligibleCategories.join(', ') + ')' : ''}` : 'Unknown Round';
        if(confirm(`Are you sure you want to unlock scores for ${judge?.name} in ${roundDisplay}? They will be able to edit and resubmit.`)){
          delete state.submissions[key];
          logAudit('unlock_scores',key);
          saveState();
          syncToFirestore(true);
          alert('Scores unlocked successfully. Judge can now edit and resubmit.');
          populateUnlockSelects();
          render(); // Refresh the view to show unlocked state
        }
      };
    }

    // --- Initialize and auto-reconnect to Firestore ---
    async function initApp(){
      render();
      populateUnlockSelects();
      setupUnlockButton();
      
      // If cloud was previously enabled, try to reconnect
      if(state.cloud.enabled && state.cloud.firebaseConfig && state.cloud.eventCode){
        try{
          await initFirebase(state.cloud.firebaseConfig);
          await loadFromFirestore();
          startFirestoreListener();
          console.log('Auto-reconnected to Firestore');
          
          // Set up Firebase Auth state listener
          fb.auth.onAuthStateChanged((user) => {
            if(user && state.me.role === 'admin') {
              // User is signed in and already has admin role
              console.log('Firebase Auth: Admin user authenticated', user.email);
              state.me.uid = user.uid;
              if(!state.me.name) {
                state.me.name = user.displayName || user.email.split('@')[0];
              }
              saveState();
            } else if(user && !state.me.role) {
              // User is signed in but no local session - restore admin session
              console.log('Firebase Auth: Restoring admin session', user.email);
              state.me.uid = user.uid;
              state.me.name = user.displayName || user.email.split('@')[0];
              state.me.role = 'admin';
              state.me.judgeId = null;
              saveState();
              currentTab = 'setup';
              render();
            } else if(!user && state.me.role === 'admin') {
              // User signed out but local session still exists - clear it
              console.log('Firebase Auth: User signed out, clearing session');
              state.me = {uid:null,name:'',role:'',judgeId:null};
              saveState();
              currentTab = 'login';
              render();
            }
          });
          
        }catch(err){
          console.warn('Failed to auto-reconnect to Firestore:', err);
          // Don't disable cloud - user can manually reconnect from Settings
        }
      }
    }

    // Kick off
    initApp();
  </script>
</body>
</html>
